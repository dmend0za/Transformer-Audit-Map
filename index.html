<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transformer Audit Map</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
/* Basic styling for the body and map container */
body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}

#legend {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    font-size: 14px;
    min-width: 220px; /* Adjusted width */
    border: 1px solid #ccc;
}

#legend h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
}

.legend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
    padding: 4px 0;
}

.legend-symbol {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    border: 1px solid #000;
    display: inline-block;
}

.legend-symbol.underground {
    background-color: #4CAF50;
}

.legend-symbol.overhead {
    background-color: hsl(123, 7%, 85%);
    border-radius: 50%;
}

.legend-count {
    font-weight: 600;
    color: #333;
}

.status-pending { color: #ff6b35; }
.status-completed { color: #4CAF50; }
.status-total { color: #333; }

#unsupported {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    justify-content: center;
    align-items: center;
    text-align: center;
    background-color: #f8f8f8;
    flex-direction: column;
}

/* Styling for the popups */
.mapboxgl-popup {
    max-width: 250px;
    font-size: 14px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.mapboxgl-popup-content {
    padding: 15px;
    border-radius: 8px;
}

.mapboxgl-popup-content h4 {
    margin: 0 0 5px 0;
    color: #333;
    font-weight: 600;
}

.mapboxgl-popup-content p {
    margin: 0;
    color: #555;
}

.mapboxgl-popup-content a {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
    display: inline-block;
    margin-top: 10px;
}

.mapboxgl-popup-content a:hover {
    text-decoration: underline;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="legend">
    <h3>Transformer Audit Status</h3>
    <div class="legend-item">
        <div>
            <span class="legend-symbol underground"></span>
            Underground
        </div>
        <span class="legend-count" id="underground-count">-</span>
    </div>
    <div class="legend-item">
        <div>
            <span class="legend-symbol overhead"></span>
            Overhead
        </div>
        <span class="legend-count" id="overhead-count">-</span>
    </div>
    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
    <div class="legend-item">
        <div class="status-total">Total Transformers:</div>
        <span class="legend-count status-total" id="total-count">-</span>
    </div>
    <div class="legend-item">
        <div class="status-completed">Completed Audits:</div>
        <span class="legend-count status-completed" id="completed-count">0</span>
    </div>
    <div class="legend-item">
        <div class="status-pending">Pending Audits:</div>
        <span class="legend-count status-pending" id="pending-count">-</span>
    </div>
</div>

<div id="unsupported">
    <h1>Mapbox GL JS is not supported by your browser.</h1>
    <p>Please use a modern browser like Chrome, Firefox, or Safari.</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Check for Mapbox GL support
    if (mapboxgl.supported()) {
        mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN'; // Replace with your token

        const sheetId = 'YOUR_GOOGLE_SHEET_ID'; // Replace with your Sheet ID
        const sheetGid = 'YOUR_GID'; // Replace with your Sheet GID
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${sheetGid}`;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-77.915, 35.73], // Centered on Wilson, NC
            zoom: 12
        });

        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        // --- 1. NEW FUNCTION: Update legend with static totals ---
        const updateStaticLegend = (counts) => {
            document.getElementById('underground-count').textContent = counts.underground;
            document.getElementById('overhead-count').textContent = counts.overhead;
            document.getElementById('total-count').textContent = counts.total;
            document.getElementById('completed-count').textContent = counts.completed;
            document.getElementById('pending-count').textContent = counts.pending;
        };

        const fetchDataAndInitializeMap = async () => {
            try {
                // Fetch all data concurrently
                const [transformersResponse, sheetResponse] = await Promise.all([
                    fetch('/data/transformers.json'), // Path to your transformers GeoJSON
                    fetch(sheetUrl)
                ]);

                if (!transformersResponse.ok) throw new Error(`Failed to fetch transformers.json: ${transformersResponse.statusText}`);
                if (!sheetResponse.ok) throw new Error(`Failed to fetch Google Sheet: ${sheetResponse.statusText}`);

                const transformersData = await transformersResponse.json();
                const allTransformerFeatures = transformersData.features;

                // --- 2. Calculate totals from the full dataset ---
                let totalUnderground = 0;
                let totalOverhead = 0;
                allTransformerFeatures.forEach(feature => {
                    if (feature.properties.Trans_Type === 'Underground') {
                        totalUnderground++;
                    } else if (feature.properties.Trans_Type === 'Overhead') {
                        totalOverhead++;
                    }
                });
                const totalTransformers = allTransformerFeatures.length;

                // Process sheet data to get completed transformer IDs
                const csvText = await sheetResponse.text();
                const rows = csvText.split('\n').slice(1); // Skip header row
                const completedTransformers = new Set();
                rows.forEach(row => {
                    const columns = row.split(',');
                    const transformerId = columns[1]?.trim().replace(/"/g, ''); // Assuming ID is in the second column
                    if (transformerId) {
                        completedTransformers.add(transformerId);
                    }
                });

                const completedCount = completedTransformers.size;
                const pendingCount = totalTransformers - completedCount;

                const counts = {
                    underground: totalUnderground,
                    overhead: totalOverhead,
                    total: totalTransformers,
                    completed: completedCount,
                    pending: pendingCount
                };
                
                // Initialize the map with the processed data
                initializeMap(completedTransformers, counts);

            } catch (error) {
                console.error("Error loading map data:", error);
                alert("Could not load data for the map. Please check the console for details.");
            }
        };

        const initializeMap = (completedTransformers, counts) => {
            // Update the legend with the calculated totals immediately
            updateStaticLegend(counts);

            const completedTransformerIds = Array.from(completedTransformers);

            map.on('load', () => {
                map.addSource('gis_data', {
                    type: 'geojson',
                    data: '/data/gis_data.geojson' // Path to your combined GeoJSON
                });

                // Add Feeder Lines Layer (no filter)
                map.addLayer({
                    'id': 'feeders',
                    'type': 'line',
                    'source': 'gis_data',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#FFA500',
                        'line-width': 2
                    },
                    'filter': ['==', ['geometry-type'], 'LineString']
                });

                // Add Electric Meters Layer
                map.addLayer({
                    'id': 'electric-meters',
                    'type': 'circle',
                    'source': 'gis_data',
                    'paint': {
                        'circle-radius': 5,
                        'circle-color': '#00BFFF',
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 1.5
                    },
                    // --- 3. ADDED FILTER: Hide meters associated with completed transformers ---
                    // IMPORTANT: Replace 'TRANSFORMER_ID' with the actual property name in your GeoJSON
                    // that links a meter to its transformer (e.g., 'LOCDESC', 'TRANS_ID').
                    'filter': [
                        'all',
                        ['==', ['geometry-type'], 'Point'],
                        ['!', ['has', 'Trans_Type']], // Filter for features that are not transformers
                        ['!', ['in', ['get', 'TRANSFORMER_ID'], ['literal', completedTransformerIds]]]
                    ]
                });

                // Add Underground Transformers Layer (Pending Only)
                map.addLayer({
                    'id': 'transformers-underground',
                    'type': 'symbol',
                    'source': 'gis_data',
                    'layout': {
                        'icon-image': 'your-underground-icon', // Replace with your Mapbox icon name
                        'icon-allow-overlap': true
                    },
                    'filter': [
                        'all',
                        ['==', ['get', 'Trans_Type'], 'Underground'],
                        ['!', ['in', ['get', 'LOCDESC'], ['literal', completedTransformerIds]]]
                    ]
                });

                // Add Overhead Transformers Layer (Pending Only)
                map.addLayer({
                    'id': 'transformers-overhead',
                    'type': 'symbol',
                    'source': 'gis_data',
                    'layout': {
                        'icon-image': 'your-overhead-icon', // Replace with your Mapbox icon name
                        'icon-allow-overlap': true
                    },
                    'filter': [
                        'all',
                        ['==', ['get', 'Trans_Type'], 'Overhead'],
                        ['!', ['in', ['get', 'LOCDESC'], ['literal', completedTransformerIds]]]
                    ]
                });

                // Add popups and interactivity
                setupInteractivity();
            });
        };
        
        const setupInteractivity = () => {
            const createTransformerPopup = (e) => {
                const properties = e.features[0].properties;
                const coordinates = e.features[0].geometry.coordinates.slice();
                const filloutUrl = `YOUR_GOOGLE_FORM_PREFILL_LINK${properties.LOCDESC}`; // Adjust your prefill link

                let popupHTML = `
                    <h4>Transformer</h4>
                    <p><strong>ID:</strong> ${properties.LOCDESC || 'N/A'}</p>
                    <p><strong>Type:</strong> ${properties.Trans_Type || 'N/A'}</p>
                    <p><strong>Feeder:</strong> ${properties.FEEDERID || 'N/A'}</p>
                    <a href="${filloutUrl}" target="_blank">Open Audit Form &rarr;</a>`;

                popup.setLngLat(coordinates).setHTML(popupHTML).addTo(map);
            };

            const createMeterPopup = (e) => {
                const properties = e.features[0].properties;
                const coordinates = e.features[0].geometry.coordinates.slice();
                
                const popupHTML = `
                    <h4>Electric Meter</h4>
                    <p><strong>Meter Number:</strong> ${properties.MTRNUM || 'N/A'}</p>
                    <p><strong>Feeder:</strong> ${properties.FEEDERID || 'N/A'}</p>`;
                
                popup.setLngLat(coordinates).setHTML(popupHTML).addTo(map);
            };

            const interactiveLayers = [
                'transformers-underground', 
                'transformers-overhead', 
                'electric-meters'
            ];

            interactiveLayers.forEach(layerId => {
                map.on('click', layerId, (e) => {
                    if (layerId.includes('transformer')) {
                        createTransformerPopup(e);
                    } else if (layerId.includes('meter')) {
                        createMeterPopup(e);
                    }
                });

                map.on('mouseenter', layerId, () => { map.getCanvas().style.cursor = 'pointer'; });
                map.on('mouseleave', layerId, () => { map.getCanvas().style.cursor = ''; });
            });
        };

        // Start the process
        fetchDataAndInitializeMap();

        // Add map controls
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(
            new mapboxgl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true,
                showUserHeading: true
            })
        );

    } else {
        // If WebGL is not supported, hide the map and show the error message.
        document.getElementById('map').style.display = 'none';
        document.getElementById('unsupported').style.display = 'flex';
    }
});
</script>

</body>
</html>
