<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer Audit Map</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <style>
        /* Basic styling for the body and map container */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #legend {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 14px;
            min-width: 200px;
            border: 1px solid #ccc;
        }

        #legend h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 4px 0;
        }

        .legend-symbol {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border: 1px solid #000;
            display: inline-block;
        }

        .legend-symbol.underground {
            background-color: #4CAF50;
        }

        .legend-symbol.overhead {
            background-color: hsl(123, 7%, 85%);
            border-radius: 50%;
        }

        .legend-symbol.meter {
            background-color: #555555;
            border: 1px solid #fff;
            border-radius: 50%;
        }
        
        .legend-symbol.transformer {
             background-color: #FF5733; /* Example color for transformer */
        }


        .legend-count {
            font-weight: 600;
            color: #333;
        }

        .status-pending { color: #ff6b35; }
        .status-completed { color: #4CAF50; }

        .mapboxgl-popup {
            max-width: 280px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            border-radius: 6px;
        }

        .mapboxgl-popup-content {
            padding: 15px;
            border-radius: 6px;
        }
        
        .mapboxgl-popup-content h4 {
            margin: 0 0 8px;
            color: #333;
            font-weight: 600;
        }
        
        .mapboxgl-popup-content p {
            margin: 4px 0;
            color: #555;
        }
        
        .mapboxgl-popup-content strong {
            color: #111;
        }

        /* Loading indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 2000;
            display: none; /* Hidden by default */
        }
        
        /* Message for unsupported browsers */
        #unsupported {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            font-size: 18px;
            color: #555;
        }

    </style>
</head>
<body>

<div id="map"></div>
<div id="legend">
    <h3>Audit Status</h3>
    <div class="legend-item">
        <span><span class="legend-symbol transformer"></span>Transformers</span>
        <span id="transformer-count" class="legend-count">0</span>
    </div>
    <div class="legend-item">
        <span><span class="legend-symbol meter"></span>Meters</span>
        <span id="meter-count" class="legend-count">0</span>
    </div>
    <div class="legend-item">
        <span><span class="legend-symbol underground"></span>Underground</span>
        <span id="underground-count" class="legend-count">0</span>
    </div>
    <div class="legend-item">
        <span><span class="legend-symbol overhead"></span>Overhead</span>
        <span id="overhead-count" class="legend-count">0</span>
    </div>
</div>

<div id="loading">Loading Data...</div>

<div id="unsupported">
    <h1>Map cannot be displayed</h1>
    <p>Your browser does not support the features required to show this map.</p>
</div>


<script>
    // FIX: Add a flag to check if sources have been added initially
    let sourcesInitialized = false;

    // Your Mapbox access token
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFzYW5vMjAyMCIsImEiOiJjbDlweWRpNjgwNGJjM3VtemR4cGIzcG5vIn0.23tDS3U250iShF4Rzlmj3w';

    // Google Sheet URL
    const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-9Ld_C2y2DsdmXGkH1n2Geg95xG6Lgq7f-vS_jY4FjH-7Ew8_hO2-gLzB-wN_rY9XzD_nQ/pub?output=csv';

    // Initialize the map
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12', // Satellite streets style
        center: [-79.9193, 35.7596], // Centered on North Carolina
        zoom: 7
    });

    // Helper function to create popup HTML for transformers
    function createTransformerPopup(e) {
        const props = e.features[0].properties;
        const formURL = `https://your-form-url.com?transformerId=${props.transformerId}`; // Customize your form URL
        const popupHTML = `
            <h4>Transformer Details</h4>
            <p><strong>ID:</strong> ${props.transformerId}</p>
            <p><strong>Status:</strong> <span class="${props.status === 'Completed' ? 'status-completed' : 'status-pending'}">${props.status}</span></p>
            <a href="${formURL}" target="_blank" rel="noopener noreferrer">Complete Audit Form</a>
        `;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupHTML)
            .addTo(map);
    }

    // Helper function to create popup HTML for meters
    function createMeterPopup(e) {
        const props = e.features[0].properties;
        const formURL = `https://your-form-url.com?meterId=${props.meterId}`; // Customize your form URL
        const popupHTML = `
            <h4>Meter Details</h4>
            <p><strong>ID:</strong> ${props.meterId}</p>
            <p><strong>Transformer:</strong> ${props.transformerId}</p>
            <p><strong>Status:</strong> <span class="${props.status === 'Completed' ? 'status-completed' : 'status-pending'}">${props.status}</span></p>
            <a href="${formURL}" target="_blank" rel="noopener noreferrer">Complete Audit Form</a>
        `;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupHTML)
            .addTo(map);
    }
    
    // Helper function to parse CSV data
    function parseCSV(csv) {
        const lines = csv.split('\n');
        const result = [];
        const headers = lines[0].trim().split(',');
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const obj = {};
            const currentline = lines[i].trim().split(',');
            for (let j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentline[j];
            }
            result.push(obj);
        }
        return result;
    }

    // FIX: New function to update the legend with total counts
    function updateLegendWithTotals(totals) {
        document.getElementById('transformer-count').textContent = totals.transformers;
        document.getElementById('meter-count').textContent = totals.meters;
        document.getElementById('underground-count').textContent = totals.underground;
        document.getElementById('overhead-count').textContent = totals.overhead;
    }

    // Function to process the fetched data and update the map
    function processData(csvData) {
        const data = parseCSV(csvData);

        const transformers = { type: 'FeatureCollection', features: [] };
        const meters = { type: 'FeatureCollection', features: [] };
        const undergroundFeeders = { type: 'FeatureCollection', features: [] };
        const overheadFeeders = { type: 'FeatureCollection', features: [] };
        
        // FIX: Initialize total counts
        const totals = { transformers: 0, meters: 0, underground: 0, overhead: 0 };

        data.forEach(row => {
            // FIX: Filter out rows that are marked as "Completed"
            if (row.Status && row.Status.trim() === 'Completed') {
                return; // Skip this row
            }

            const transLat = parseFloat(row.TransformerLatitude);
            const transLon = parseFloat(row.TransformerLongitude);
            const meterLat = parseFloat(row.MeterLatitude);
            const meterLon = parseFloat(row.MeterLongitude);

            if (!isNaN(transLon) && !isNaN(transLat)) {
                transformers.features.push({
                    type: 'Feature',
                    properties: {
                        transformerId: row.TransformerID,
                        status: row.Status || 'Pending'
                    },
                    geometry: { type: 'Point', coordinates: [transLon, transLat] }
                });
                // FIX: Increment total transformer count
                totals.transformers++;
            }

            if (!isNaN(meterLon) && !isNaN(meterLat)) {
                meters.features.push({
                    type: 'Feature',
                    properties: {
                        meterId: row.MeterNumber,
                        transformerId: row.TransformerID,
                        status: row.Status || 'Pending'
                    },
                    geometry: { type: 'Point', coordinates: [meterLon, meterLat] }
                });
                // FIX: Increment total meter count
                totals.meters++;
            }
            
            if (!isNaN(transLon) && !isNaN(transLat) && !isNaN(meterLon) && !isNaN(meterLat)) {
                const feeder = {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: [[transLon, transLat], [meterLon, meterLat]]
                    }
                };
                if (row.FeederType === 'Underground') {
                    undergroundFeeders.features.push(feeder);
                    // FIX: Increment total underground count
                    totals.underground++;
                } else if (row.FeederType === 'Overhead') {
                    overheadFeeders.features.push(feeder);
                    // FIX: Increment total overhead count
                    totals.overhead++;
                }
            }
        });

        // FIX: Update the map sources with the new data
        // If sources haven't been added yet, use addSource. Otherwise, use setData.
        if (!sourcesInitialized) {
            map.addSource('transformers', { type: 'geojson', data: transformers });
            map.addSource('meters', { type: 'geojson', data: meters });
            map.addSource('underground-feeders', { type: 'geojson', data: undergroundFeeders });
            map.addSource('overhead-feeders', { type: 'geojson', data: overheadFeeders });
        } else {
            map.getSource('transformers').setData(transformers);
            map.getSource('meters').setData(meters);
            map.getSource('underground-feeders').setData(undergroundFeeders);
            map.getSource('overhead-feeders').setData(overheadFeeders);
        }

        // FIX: Update legend with the new total counts
        updateLegendWithTotals(totals);
    }
    
    // FIX: Create a function to fetch and refresh data
    async function refreshData() {
        document.getElementById('loading').style.display = 'block';
        try {
            const response = await fetch(googleSheetURL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvData = await response.text();
            processData(csvData);
        } catch (error) {
            console.error("Failed to fetch or process data:", error);
            alert("Could not load map data. Please check the console for more details.");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }


    // Main execution block
    map.on('load', () => {
        // Check for WebGL support
        if (mapboxgl.supported()) {
            
            // Initial data load
            refreshData().then(() => {
                
                // Add layers only after the first successful data load
                if (!sourcesInitialized) {
                    map.addLayer({
                        id: 'feeders-underground',
                        type: 'line',
                        source: 'underground-feeders',
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#4CAF50', 'line-width': 2 }
                    });

                    map.addLayer({
                        id: 'feeders-overhead',
                        type: 'line',
                        source: 'overhead-feeders',
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#888888', 'line-width': 2, 'line-dasharray': [2, 2] }
                    });

                    map.addLayer({
                        id: 'transformers-overhead',
                        type: 'circle',
                        source: 'transformers',
                        paint: {
                            'circle-radius': 8,
                            'circle-color': '#FF5733',
                            'circle-stroke-color': 'white',
                            'circle-stroke-width': 2
                        }
                    });

                    map.addLayer({
                        id: 'electric-meters',
                        type: 'circle',
                        source: 'meters',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': '#555555',
                            'circle-stroke-color': 'white',
                            'circle-stroke-width': 1
                        }
                    });

                    // Add labels for transformers
                    map.addLayer({
                        id: 'transformer-labels',
                        type: 'symbol',
                        source: 'transformers',
                        layout: {
                            'text-field': ['get', 'transformerId'],
                            'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 1.5],
                            'text-anchor': 'top',
                            'text-size': 12
                        },
                        paint: {
                            'text-color': '#ffffff',
                            'text-halo-color': '#000000',
                            'text-halo-width': 1
                        }
                    });

                    // Add labels for meters
                    map.addLayer({
                        id: 'meter-labels',
                        type: 'symbol',
                        source: 'meters',
                        layout: {
                            'text-field': ['get', 'meterId'],
                            'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, -1.5],
                            'text-anchor': 'bottom',
                            'text-size': 10
                        },
                        paint: {
                            'text-color': '#ffffff',
                            'text-halo-color': '#000000',
                            'text-halo-width': 1
                        }
                    });

                    sourcesInitialized = true; // Set flag to true after initial setup
                }

                // FIX: Set an interval to refresh data periodically (e.g., every 30 seconds)
                setInterval(refreshData, 30000); // 30000 milliseconds = 30 seconds
            });

            // Set up interactivity for layers
            const interactiveLayers = [
                'transformers-overhead', 
                'electric-meters',
                'transformer-labels',
                'meter-labels'
            ];
            
            interactiveLayers.forEach(layerId => {
                map.on('click', layerId, (e) => {
                    if (layerId.includes('transformer')) {
                        createTransformerPopup(e);
                    } else if (layerId.includes('meter')) {
                        createMeterPopup(e);
                    }
                });

                map.on('mouseenter', layerId, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', layerId, () => {
                    map.getCanvas().style.cursor = '';
                });
            });
        } else {
            // If WebGL is not supported, hide the map and show the error message.
            document.getElementById('map').style.display = 'none';
            document.getElementById('unsupported').style.display = 'flex';
        }

        // Add zoom and rotation controls to the map.
        map.addControl(new mapboxgl.NavigationControl());
    });
</script>

</body>
</html>
