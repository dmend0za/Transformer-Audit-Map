<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transformer Audit Map</title>
<!-- Mapbox GL JS CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<!-- Mapbox GL JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
/* Basic styling for the body and map container */
body {
margin: 0;
padding: 0;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

#map {
position: absolute;
top: 0;
bottom: 0;
width: 100%;
}

#legend {
position: absolute;
top: 20px;
left: 20px;
background: rgba(255, 255, 255, 0.95);
padding: 15px;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
z-index: 1000;
font-size: 14px;
min-width: 200px;
border: 1px solid #ccc;
}

#legend h3 {
margin: 0 0 10px 0;
color: #333;
font-size: 16px;
font-weight: 600;
}

.legend-item {
display: flex;
justify-content: space-between;
align-items: center;
margin: 8px 0;
padding: 4px 0;
}

.legend-symbol {
width: 16px;
height: 16px;
margin-right: 8px;
border: 1px solid #000;
display: inline-block;
}

.legend-symbol.underground {
background-color: #4CAF50;
}

.legend-symbol.overhead {
background-color: hsl(123, 7%, 85%);
border-radius: 50%;
}

.legend-symbol.meter {
background-color: #555555;
border: 1px solid #fff;
border-radius: 50%;
}

.legend-count {
font-weight: 600;
color: #333;
}

.status-pending { color: #ff6b35; }
.status-completed { color: #4CAF50; }
.status-total { color: #333; }

#unsupported {
display: none;
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
justify-content: center;
align-items: center;
text-align: center;
background-color: #f8f8f8;
flex-direction: column;
}

/* Styling for the popups */
.mapboxgl-popup {
max-width: 250px;
font-size: 14px;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.mapboxgl-popup-content {
padding: 15px;
border-radius: 8px;
}

.mapboxgl-popup-content h4 {
margin: 0 0 5px 0;
color: #333;
font-weight: 600;
}

.mapboxgl-popup-content p {
margin: 0;
color: #555;
}

.mapboxgl-popup-content a {
color: #007bff;
text-decoration: none;
font-weight: bold;
display: inline-block;
margin-top: 10px;
}

.mapboxgl-popup-content a:hover {
text-decoration: underline;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="legend">
<h3>Transformer Audit Status</h3>
<div class="legend-item">
<div>
<span class="legend-symbol underground"></span>
Underground
</div>
<span class="legend-count" id="underground-count">-</span>
</div>
<div class="legend-item">
<div>
<span class="legend-symbol overhead"></span>
Overhead
</div>
<span class="legend-count" id="overhead-count">-</span>
</div>
<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
<div class="legend-item">
<div class="status-total">Total Transformers:</div>
<span class="legend-count status-total" id="total-count">-</span>
</div>
<div class="legend-item">
<div class="status-completed">Completed Audits:</div>
<span class="legend-count status-completed" id="completed-count">0</span>
</div>
<div class="legend-item">
<div class="status-pending">Remaining Audits:</div>
<span class="legend-count status-pending" id="pending-count">-</span>
</div>
</div>

<div id="unsupported">
<h2>WebGL not supported</h2>
<p>Your browser or device does not support WebGL, which is required to display this map.</p>
<p>Please try updating your browser or using a different device.</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// Check if WebGL is supported
if (!mapboxgl.supported()) {
document.getElementById('map').style.display = 'none';
document.getElementById('unsupported').style.display = 'flex';
return;
}

// Initialize the map
mapboxgl.accessToken = 'pk.eyJ1IjoiY2l0eW9ma2VubHkiLCJhIjoiY20wMjhqcXJzMGhlZzJsczR2ZXZicDk3NiJ9.4EdrKRPjLOQ1Kl8FRc5-tw';

const map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/cityofkenly/cm028kd0d001601qzg9w4c2y6',
center: [-78.1344, 35.6734], // Kenly, NC
zoom: 16
});

const popup = new mapboxgl.Popup({
closeButton: true,
closeOnClick: false
});

// Store completed transformer IDs
let completedTransformerIds = new Set();

// Function to check if a value exists and is not empty
const hasValue = (value) => {
return value !== undefined && value !== null && value !== '' && value.toString().trim() !== '';
};

// Function to update map data and counts
const updateMapData = async () => {
try {
console.log('Fetching spreadsheet data...');
const response = await fetch('https://docs.google.com/spreadsheets/d/1ywqJF3DJu5mJZKZQHGn4VoQEHkgqUIiWf7xTIFBhm5s/export?format=csv&gid=0');
if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}
const csvText = await response.text();
console.log('CSV data received, length:', csvText.length);

const rows = csvText.split('\n');
const newCompletedIds = new Set();

// Skip header row, process data rows
for (let i = 1; i < rows.length; i++) {
const row = rows[i];
if (!row.trim()) continue;

const columns = row.split(',');
if (columns.length < 11) continue; // Ensure we have enough columns

// Column D (index 3) for status, Column K (index 10) for transformer ID
const status = columns[3]?.trim().replace(/"/g, '');
const transformerId = columns[10]?.trim().replace(/"/g, '');

console.log(`Row ${i}: Status="${status}", TransformerID="${transformerId}"`);

if (transformerId && status?.toLowerCase() === 'complete') {
newCompletedIds.add(transformerId);
console.log(`Added completed transformer: ${transformerId}`);
}
}

console.log('New completed IDs:', Array.from(newCompletedIds));
console.log('Previous completed IDs:', Array.from(completedTransformerIds));

// Update the completed IDs set
completedTransformerIds = newCompletedIds;

// Filter map features to hide completed transformers and their meters
if (map.getLayer('transformers-underground')) {
updateLayerFilters();
}

updateLegendCounts();
console.log(`Total completed transformers: ${completedTransformerIds.size}`);

} catch (error) {
console.error('Error updating map data:', error);
}
};

// Function to update layer filters to hide completed transformers and their meters
const updateLayerFilters = () => {
const completedIdsArray = Array.from(completedTransformerIds);

console.log('Applying filters for completed IDs:', completedIdsArray);

// Create filter to exclude completed transformers
const transformerFilter = completedIdsArray.length > 0 
? ['!', ['in', ['get', 'TXID'], ['literal', completedIdsArray]]]
: null;

// Create filter to exclude meters associated with completed transformers
const meterFilter = completedIdsArray.length > 0
? ['!', ['in', ['get', 'TXID'], ['literal', completedIdsArray]]]
: null;

// Apply filters to transformer layers
['transformers-underground', 'transformers-overhead', 'transformer-labels'].forEach(layerId => {
if (map.getLayer(layerId)) {
if (transformerFilter) {
map.setFilter(layerId, transformerFilter);
console.log(`Applied transformer filter to ${layerId}`);
} else {
map.setFilter(layerId, null);
console.log(`Removed filter from ${layerId}`);
}
}
});

// Apply filters to meter layers
['electric-meters', 'meter-labels'].forEach(layerId => {
if (map.getLayer(layerId)) {
if (meterFilter) {
map.setFilter(layerId, meterFilter);
console.log(`Applied meter filter to ${layerId}`);
} else {
map.setFilter(layerId, null);
console.log(`Removed filter from ${layerId}`);
}
}
});
};

// Function to count features that pass the current filter
const countVisibleFeatures = (layerId) => {
if (!map.getLayer(layerId)) return 0;

const features = map.querySourceFeatures('composite', {
sourceLayer: layerId.includes('transformer') ? 'Electric_Transformers-aacayl' : 'Electric_Meters-6v8wgf'
});

if (!features) return 0;

const completedIdsArray = Array.from(completedTransformerIds);

return features.filter(feature => {
const txid = feature.properties.TXID;
return !completedIdsArray.includes(txid);
}).length;
};

// Function to update legend counts
const updateLegendCounts = () => {
try {
// Count visible (non-completed) features
const undergroundCount = countVisibleFeatures('transformers-underground');
const overheadCount = countVisibleFeatures('transformers-overhead');
const totalVisible = undergroundCount + overheadCount;
const completedCount = completedTransformerIds.size;

console.log('Legend counts:', {
underground: undergroundCount,
overhead: overheadCount,
totalVisible,
completed: completedCount
});

// Update legend display
document.getElementById('underground-count').textContent = undergroundCount;
document.getElementById('overhead-count').textContent = overheadCount;
document.getElementById('total-count').textContent = totalVisible + completedCount;
document.getElementById('completed-count').textContent = completedCount;
document.getElementById('pending-count').textContent = totalVisible;

} catch (error) {
console.error('Error updating legend counts:', error);
}
};

// Map load event handler
map.on('load', () => {
console.log('Map loaded successfully');
updateMapData();
updateLegendCounts();

// Set up periodic updates every 30 seconds
setInterval(updateMapData, 30000);

// Create popup for transformers
const createTransformerPopup = (e) => {
const properties = e.features[0].properties;
const coordinates = e.features[0].geometry.coordinates.slice();

// Ensure longitude doesn't exceed 180 degrees
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}

console.log('Transformer properties:', properties);

// Create the Fillout form URL with pre-filled data
const filloutUrl = `https://forms.fillout.com/t/rr4X9kBBZMus?TXID=${encodeURIComponent(properties.TXID || '')}&TYPE=${encodeURIComponent(properties.TYPE || '')}&KVA=${encodeURIComponent(properties.KVA || '')}&VOLTAGE=${encodeURIComponent(properties.VOLTAGE || '')}&FEEDERID=${encodeURIComponent(properties.FEEDERID || '')}&COLOR=${encodeURIComponent(properties.COLOR || '')}&STYLE=${encodeURIComponent(properties.STYLE || '')}`;

// Build popup content
let popupHTML = `<h4>${properties.TYPE || 'Unknown'} Transformer</h4>`;
popupHTML += `<p><strong>ID:</strong> ${properties.TXID || 'N/A'}</p>`;

// Only add KVA field if it has a value
if (hasValue(properties.KVA)) {
popupHTML += `<p><strong>KVA:</strong> ${properties.KVA}</p>`;
console.log('KVA field added:', properties.KVA);
} else {
console.log('KVA field skipped for value:', properties.KVA);
}

// Only add VOLTAGE field if it has a value
if (hasValue(properties.VOLTAGE)) {
popupHTML += `<p><strong>VOLTAGE:</strong> ${properties.VOLTAGE}</p>`;
console.log('VOLTAGE field added:', properties.VOLTAGE);
} else {
console.log('VOLTAGE field skipped for value:', properties.VOLTAGE);
}

// Only add FEEDERID field if it has a value
if (hasValue(properties.FEEDERID)) {
popupHTML += `<p><strong>FEEDER:</strong> ${properties.FEEDERID}</p>`;
console.log('FEEDERID field added:', properties.FEEDERID);
} else {
console.log('FEEDERID field skipped for value:', properties.FEEDERID);
}

// Only add COLOR field if it has a value
if (hasValue(properties.COLOR)) {
popupHTML += `<p><strong>COLOR:</strong> ${properties.COLOR}</p>`;
console.log('COLOR field added:', properties.COLOR);
} else {
console.log('COLOR field skipped for value:', properties.COLOR);
}

// Only add STYLE field if it has a value
if (hasValue(properties.STYLE)) {
popupHTML += `<p><strong>STYLE:</strong> ${properties.STYLE}</p>`;
console.log('STYLE field added:', properties.STYLE);
} else {
console.log('STYLE field skipped for value:', properties.STYLE);
}

// Add the audit form link
popupHTML += `<a href="${filloutUrl}" target="_blank">Open Audit Form &rarr;</a>`;

popup.setLngLat(coordinates).setHTML(popupHTML).addTo(map);
};

const createMeterPopup = (e) => {
const properties = e.features[0].properties;
const coordinates = e.features[0].geometry.coordinates.slice();
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}
const popupHTML = `
                     <h4>Electric Meter</h4>
                     <p><strong>Meter Number:</strong> ${properties.MTRNUM || 'N/A'}</p>
                     <p><strong>Feeder:</strong> ${properties.FEEDERID || 'N/A'}</p>
                 `;
popup.setLngLat(coordinates).setHTML(popupHTML).addTo(map);
};

// Add click listeners for each interactive layer
const interactiveLayers = [
'transformers-underground', 
'transformers-overhead', 
'electric-meters',
'transformer-labels',
'meter-labels'
];
interactiveLayers.forEach(layerId => {
map.on('click', layerId, (e) => {
if (layerId.includes('transformer')) {
createTransformerPopup(e);
} else if (layerId.includes('meter')) {
createMeterPopup(e);
}
});

map.on('mouseenter', layerId, () => {
map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', layerId, () => {
map.getCanvas().style.cursor = '';
});
});
});

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl());
});
</script>

</body>
</html>
