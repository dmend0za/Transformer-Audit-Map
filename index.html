<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Transformer Audit System</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.9);
            margin: 10px;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            z-index: 1;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .layer-control {
            margin: 5px 0;
        }
        
        .layer-control input {
            margin-right: 5px;
        }
        
        .popup-content {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .audit-button {
            background: #007cbf;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .audit-button:hover {
            background: #005a8b;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    
    <div class='map-overlay'>
        <h3>Layer Controls</h3>
        <div class='layer-control'>
            <input type='checkbox' id='transformer-toggle' checked>
            <label for='transformer-toggle'>Transformer Banks</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='meters-toggle' checked>
            <label for='meters-toggle'>Electric Meters</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='secondary-oh-toggle' checked>
            <label for='secondary-oh-toggle'>Secondary Overhead</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='secondary-ug-toggle' checked>
            <label for='secondary-ug-toggle'>Secondary Underground</label>
        </div>
        
        <div class='debug-info' id='debug-info'>
            <strong>Debug Info:</strong><br>
            Loading tileset information...
        </div>
    </div>
    
    <div class='loading' id='loading'>Loading map data...</div>

    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWR5emNseWgwNzk4MnVwcnUwejhvOGRpIn0.0V5SRvcXskZcqbtzeMkUnA';

        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-78.5, 35.8], // North Carolina center
            zoom: 10
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());

        // Show loading indicator
        document.getElementById('loading').style.display = 'block';
        
        // Debug info element
        const debugInfo = document.getElementById('debug-info');
        
        // Function to update debug info
        function updateDebugInfo(message) {
            debugInfo.innerHTML += message + '<br>';
            console.log(message);
        }

        map.on('load', function() {
            document.getElementById('loading').style.display = 'none';
            updateDebugInfo('Map loaded successfully');

            // Add sources and inspect them
            const tilesets = [
                { id: 'transformers', mapboxId: 'fieldsense.9i382k93', name: 'Transformer Banks' },
                { id: 'meters', mapboxId: 'fieldsense.00srtpq5', name: 'Electric Meters' },
                { id: 'secondary-oh', mapboxId: 'fieldsense.0wvcayxk', name: 'Secondary OH' },
                { id: 'secondary-ug', mapboxId: 'fieldsense.cgp8b9gy', name: 'Secondary UG' }
            ];

            tilesets.forEach(tileset => {
                try {
                    map.addSource(tileset.id, {
                        'type': 'vector',
                        'url': `mapbox://${tileset.mapboxId}`
                    });
                    updateDebugInfo(`✓ Added source: ${tileset.name}`);
                    
                    // Try to get source info
                    setTimeout(() => {
                        const source = map.getSource(tileset.id);
                        if (source && source.vectorLayerIds) {
                            updateDebugInfo(`${tileset.name} layers: ${source.vectorLayerIds.join(', ')}`);
                        }
                    }, 2000);
                    
                } catch (error) {
                    updateDebugInfo(`✗ Error adding ${tileset.name}: ${error.message}`);
                }
            });

            // Try different possible source-layer names for transformers
            const possibleTransformerNames = [
                'transformer_banks2',
                'transformer-banks2', 
                'transformerbanks2',
                'transformer_banks',
                'transformers',
                'default'
            ];

            let transformerLayerAdded = false;
            
            possibleTransformerNames.forEach((layerName, index) => {
                if (transformerLayerAdded) return;
                
                try {
                    map.addLayer({
                        'id': `transformer-test-${index}`,
                        'type': 'circle',
                        'source': 'transformers',
                        'source-layer': layerName,
                        'paint': {
                            'circle-radius': 8,
                            'circle-color': '#ff6b35',
                            'circle-stroke-color': '#ffffff',
                            'circle-stroke-width': 2,
                            'circle-opacity': 0.8
                        }
                    });
                    
                    // Check if layer has features
                    setTimeout(() => {
                        const features = map.querySourceFeatures('transformers', {
                            sourceLayer: layerName
                        });
                        
                        if (features && features.length > 0) {
                            updateDebugInfo(`✓ FOUND TRANSFORMERS: source-layer="${layerName}" (${features.length} features)`);
                            transformerLayerAdded = true;
                            
                            // Remove other test layers
                            for (let i = 0; i < possibleTransformerNames.length; i++) {
                                if (i !== index && map.getLayer(`transformer-test-${i}`)) {
                                    map.removeLayer(`transformer-test-${i}`);
                                }
                            }
                            
                            // Add click event to the working layer
                            map.on('click', `transformer-test-${index}`, function(e) {
                                const properties = e.features[0].properties;
                                
                                let popupContent = '<div class="popup-content">';
                                popupContent += '<h4>Transformer Bank</h4>';
                                
                                Object.keys(properties).slice(0, 5).forEach(key => {
                                    if (properties[key] !== null && properties[key] !== '') {
                                        popupContent += `<strong>${key}:</strong> ${properties[key]}<br>`;
                                    }
                                });
                                
                                popupContent += '<button class="audit-button" onclick="startAudit(\'' + 
                                    (properties.id || properties.objectid || 'unknown') + '\')">Start Audit</button>';
                                popupContent += '</div>';

                                new mapboxgl.Popup()
                                    .setLngLat(e.lngLat)
                                    .setHTML(popupContent)
                                    .addTo(map);
                            });
                            
                            map.on('mouseenter', `transformer-test-${index}`, function() {
                                map.getCanvas().style.cursor = 'pointer';
                            });

                            map.on('mouseleave', `transformer-test-${index}`, function() {
                                map.getCanvas().style.cursor = '';
                            });
                            
                        } else {
                            updateDebugInfo(`✗ No features found for: ${layerName}`);
                            if (map.getLayer(`transformer-test-${index}`)) {
                                map.removeLayer(`transformer-test-${index}`);
                            }
                        }
                    }, 3000);
                    
                } catch (error) {
                    updateDebugInfo(`✗ Error testing layer "${layerName}": ${error.message}`);
                }
            });

            // Also try to inspect what's actually in the tileset
            setTimeout(() => {
                updateDebugInfo('--- Inspecting tileset contents ---');
                try {
                    const source = map.getSource('transformers');
                    if (source) {
                        updateDebugInfo(`Source type: ${source.type}`);
                        if (source.vectorLayerIds) {
                            updateDebugInfo(`Available layers: ${source.vectorLayerIds.join(', ')}`);
                        }
                    }
                } catch (error) {
                    updateDebugInfo(`Error inspecting source: ${error.message}`);
                }
            }, 4000);
        });

        // Function to start audit
        function startAudit(transformerId) {
            alert(`Starting audit for transformer: ${transformerId}\n\nThis will redirect to your audit form once URLs are embedded in the data.`);
        }

        // Simple layer toggles for now
        document.getElementById('transformer-toggle').addEventListener('change', function(e) {
            // We'll update this once we find the correct layer name
            updateDebugInfo(`Transformer toggle: ${e.target.checked}`);
        });
    </script>
</body>
</html>
