<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Transformer Audit System</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.9);
            margin: 10px;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            z-index: 1;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .layer-control {
            margin: 5px 0;
        }
        
        .layer-control input {
            margin-right: 5px;
        }
        
        .popup-content {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .audit-button {
            background: #007cbf;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .audit-button:hover {
            background: #005a8b;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    
    <div class='map-overlay'>
        <h3>Layer Controls</h3>
        <div class='layer-control'>
            <input type='checkbox' id='transformer-toggle' checked>
            <label for='transformer-toggle'>Transformer Banks</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='meters-toggle' checked>
            <label for='meters-toggle'>Electric Meters</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='secondary-oh-toggle' checked>
            <label for='secondary-oh-toggle'>Secondary Overhead</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='secondary-ug-toggle' checked>
            <label for='secondary-ug-toggle'>Secondary Underground</label>
        </div>
        
        <div class='debug-info' id='debug-info'>
            <strong>Debug Info:</strong><br>
            Loading tileset information...
        </div>
    </div>
    
    <div class='loading' id='loading'>Loading map data...</div>

    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWR5emNseWgwNzk4MmtwcnUwejhvOGRpIn0.0V5SRvcXskZcqbtzeMkUnA';

        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-77.88424798136592, 35.734696861467626], // Your specified coordinates
            zoom: 12 // Increased zoom for better detail
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());

        // Show loading indicator
        document.getElementById('loading').style.display = 'block';
        
        // Debug info element
        const debugInfo = document.getElementById('debug-info');
        
        // Function to update debug info
        function updateDebugInfo(message) {
            debugInfo.innerHTML += message + '<br>';
            console.log(message);
        }

        map.on('load', function() {
            document.getElementById('loading').style.display = 'none';
            updateDebugInfo('Map loaded successfully');

            // Add sources and inspect them
            const tilesets = [
                { id: 'transformers', mapboxId: 'fieldsense.9i382k93', name: 'Transformer Banks' },
                { id: 'meters', mapboxId: 'fieldsense.00srtpq5', name: 'Electric Meters' },
                { id: 'secondary-oh', mapboxId: 'fieldsense.0wvcayxk', name: 'Secondary OH' },
                { id: 'secondary-ug', mapboxId: 'fieldsense.cgp8b9gy', name: 'Secondary UG' }
            ];

            tilesets.forEach(tileset => {
                try {
                    map.addSource(tileset.id, {
                        'type': 'vector',
                        'url': `mapbox://${tileset.mapboxId}`
                    });
                    updateDebugInfo(`✓ Added source: ${tileset.name}`);
                    
                    // Try to get source info
                    setTimeout(() => {
                        const source = map.getSource(tileset.id);
                        if (source && source.vectorLayerIds) {
                            updateDebugInfo(`${tileset.name} layers: ${source.vectorLayerIds.join(', ')}`);
                        }
                    }, 2000);
                    
                } catch (error) {
                    updateDebugInfo(`✗ Error adding ${tileset.name}: ${error.message}`);
                }
            });

            // Try different possible source-layer names for all layers
            const layerTests = [
                {
                    source: 'transformers',
                    possibleNames: [
                        'transformer_banks2',
                        'transformer-banks2', 
                        'transformerbanks2',
                        'transformer_banks',
                        'transformers',
                        'electric_meters2', // Sometimes files get mixed up
                        'default'
                    ],
                    displayName: 'Transformers',
                    color: '#ff6b35'
                },
                {
                    source: 'meters',
                    possibleNames: [
                        'electric_meters2',
                        'electric-meters2',
                        'electricmeters2',
                        'electric_meters',
                        'meters',
                        'transformer_banks2', // Check for mix-ups
                        'default'
                    ],
                    displayName: 'Meters',
                    color: '#4a90e2'
                },
                {
                    source: 'secondary-oh',
                    possibleNames: [
                        'secondary_OH2',
                        'secondary-OH2',
                        'secondaryOH2',
                        'secondary_oh2',
                        'secondary-oh2',
                        'secondaryoh2',
                        'secondary_OH',
                        'overhead',
                        'default'
                    ],
                    displayName: 'Secondary OH',
                    color: '#2ecc71'
                },
                {
                    source: 'secondary-ug',
                    possibleNames: [
                        'secondary_UG2',
                        'secondary-UG2',
                        'secondaryUG2',
                        'secondary_ug2',
                        'secondary-ug2',
                        'secondaryug2',
                        'secondary_UG',
                        'underground',
                        'default'
                    ],
                    displayName: 'Secondary UG',
                    color: '#e74c3c'
                }
            ];

            // Test each layer type
            layerTests.forEach((layerTest, testIndex) => {
                let layerFound = false;
                
                layerTest.possibleNames.forEach((layerName, nameIndex) => {
                    if (layerFound) return;
                    
                    const layerId = `${layerTest.source}-test-${nameIndex}`;
                    
                    try {
                        map.addLayer({
                            'id': layerId,
                            'type': layerTest.source.includes('secondary') ? 'line' : 'circle',
                            'source': layerTest.source,
                            'source-layer': layerName,
                            'paint': layerTest.source.includes('secondary') ? {
                                'line-color': layerTest.color,
                                'line-width': 2,
                                'line-opacity': 0.8
                            } : {
                                'circle-radius': 6,
                                'circle-color': layerTest.color,
                                'circle-stroke-color': '#ffffff',
                                'circle-stroke-width': 1,
                                'circle-opacity': 0.8
                            }
                        });
                        
                        // Check if layer has features after a delay
                        setTimeout(() => {
                            try {
                                const features = map.querySourceFeatures(layerTest.source, {
                                    sourceLayer: layerName
                                });
                                
                                if (features && features.length > 0) {
                                    updateDebugInfo(`✓ FOUND ${layerTest.displayName}: "${layerName}" (${features.length} features)`);
                                    layerFound = true;
                                    
                                    // Remove other test layers for this source
                                    layerTest.possibleNames.forEach((_, otherIndex) => {
                                        if (otherIndex !== nameIndex) {
                                            const otherLayerId = `${layerTest.source}-test-${otherIndex}`;
                                            if (map.getLayer(otherLayerId)) {
                                                map.removeLayer(otherLayerId);
                                            }
                                        }
                                    });
                                    
                                    // Add click event for transformers
                                    if (layerTest.source === 'transformers') {
                                        map.on('click', layerId, function(e) {
                                            const properties = e.features[0].properties;
                                            
                                            let popupContent = '<div class="popup-content">';
                                            popupContent += '<h4>Transformer Bank</h4>';
                                            
                                            Object.keys(properties).slice(0, 5).forEach(key => {
                                                if (properties[key] !== null && properties[key] !== '') {
                                                    popupContent += `<strong>${key}:</strong> ${properties[key]}<br>`;
                                                }
                                            });
                                            
                                            popupContent += '<button class="audit-button" onclick="startAudit(\'' + 
                                                (properties.id || properties.objectid || 'unknown') + '\')">Start Audit</button>';
                                            popupContent += '</div>';

                                            new mapboxgl.Popup()
                                                .setLngLat(e.lngLat)
                                                .setHTML(popupContent)
                                                .addTo(map);
                                        });
                                        
                                        map.on('mouseenter', layerId, function() {
                                            map.getCanvas().style.cursor = 'pointer';
                                        });

                                        map.on('mouseleave', layerId, function() {
                                            map.getCanvas().style.cursor = '';
                                        });
                                    }
                                    
                                } else {
                                    updateDebugInfo(`✗ No features: ${layerTest.displayName} - "${layerName}"`);
                                    if (map.getLayer(layerId)) {
                                        map.removeLayer(layerId);
                                    }
                                }
                            } catch (error) {
                                updateDebugInfo(`✗ Error querying ${layerTest.displayName} - "${layerName}": ${error.message}`);
                                if (map.getLayer(layerId)) {
                                    map.removeLayer(layerId);
                                }
                            }
                        }, 2000 + (testIndex * 1000)); // Stagger the tests
                        
                    } catch (error) {
                        updateDebugInfo(`✗ Error adding ${layerTest.displayName} layer "${layerName}": ${error.message}`);
                    }
                });
            });

            // Also try to inspect what's actually in the tileset
            setTimeout(() => {
                updateDebugInfo('--- Inspecting tileset contents ---');
                try {
                    const source = map.getSource('transformers');
                    if (source) {
                        updateDebugInfo(`Source type: ${source.type}`);
                        if (source.vectorLayerIds) {
                            updateDebugInfo(`Available layers: ${source.vectorLayerIds.join(', ')}`);
                        }
                    }
                } catch (error) {
                    updateDebugInfo(`Error inspecting source: ${error.message}`);
                }
            }, 4000);
        });

        // Function to start audit
        function startAudit(transformerId) {
            alert(`Starting audit for transformer: ${transformerId}\n\nThis will redirect to your audit form once URLs are embedded in the data.`);
        }

        // Simple layer toggles for now
        document.getElementById('transformer-toggle').addEventListener('change', function(e) {
            // We'll update this once we find the correct layer name
            updateDebugInfo(`Transformer toggle: ${e.target.checked}`);
        });
    </script>
</body>
</html>
