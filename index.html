}

// Expose functions globally for Google Sheets integration
window.updateAuditStatus = updateCompletedTransformers;
window.refreshAuditData = checkAuditStatus;
// --- ADD TILESET SOURCES ---
// Using the verified list of Tileset IDs.
map.addSource('transformers', {
type: 'vector',
url: 'mapbox://fieldsense.4w34kdko' 
});

map.addSource('meters', {
type: 'vector',
url: 'mapbox://fieldsense.4hey26iq'
});

map.addSource('secondary-oh', {
type: 'vector',
url: 'mapbox://fieldsense.c53vz8g4'
});

map.addSource('secondary-ug', {
type: 'vector',
url: 'mapbox://fieldsense.2hebp65r'
});

// --- ADD LAYERS ---
// Using the verified list of source layer names.

// 1. Underground Feeders Layer (Darker Blue Dashed)
map.addLayer({
'id': 'ug-feeders',
'type': 'line',
'source': 'secondary-ug',
'source-layer': 'secondary_UG-0ox1k5',
'minzoom': 17,
'layout': { 'line-join': 'round', 'line-cap': 'round' },
'paint': { 'line-color': '#003366', 'line-width': 2, 'line-dasharray': [2, 2] }
});

// 2. Overhead Feeders Layer (Red Solid) y
map.addLayer({
'id': 'oh-feeders',
'type': 'line',
'source': 'secondary-oh',
'source-layer': 'secondary_OH-27459y',
'minzoom': 17,
'layout': { 'line-join': 'round', 'line-cap': 'round' },
'paint': { 'line-color': '#FF0000', 'line-width': 2 }
});

// 3. Underground Transformers Layer (Light Green Squares)
map.addLayer({
'id': 'transformers-underground',
'type': 'symbol',
'source': 'transformers',
'source-layer': 'transformer_bank-2wyyho', 
// ✅ CORRECTED FILTER PROPERTY AND VALUE
'filter': ['==', 'TRANSFORMER', 'Underground'], 
'minzoom': 16.5,
'layout': {
'text-field': '■', // Unicode square character
'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
'text-size': 24, 
'text-allow-overlap': true,
'text-ignore-placement': true
},
'paint': {
'text-color': '#4CAF50', 
'text-halo-color': '#000000',
'text-halo-width': 1.5
}
});

// 4. Overhead Transformers Layer (Light Gray Circles)
map.addLayer({
'id': 'transformers-overhead',
'type': 'circle',
'source': 'transformers',
'source-layer': 'transformer_bank-2wyyho', 
// ✅ CORRECTED FILTER PROPERTY AND VALUE
'filter': ['!=', 'TRANSFORMER', 'Underground'],
'minzoom': 16.5,
'paint': { 
'circle-color': 'hsl(123, 7%, 85%)',
'circle-radius': 8,
'circle-stroke-width': 2, 
'circle-stroke-color': '#000000'
}
});
// 5. Electric Meters Layer (Bigger Dark Gray with White Stroke)
map.addLayer({
'id': 'electric-meters',
'type': 'circle',
'source': 'meters',
'source-layer': 'electric_meters-5xjegj',
'minzoom': 18,
'paint': { 
'circle-color': '#555555', // Dark gray
'circle-radius': 6, // Bigger than before (was 4)
'circle-stroke-width': 1, 
'circle-stroke-color': '#ffffff' // White stroke
}
});

// 6. Transformer Labels (appear at high zoom with larger dynamic sizing)
map.addLayer({
'id': 'transformer-labels',
'type': 'symbol',
'source': 'transformers',
'source-layer': 'transformer_bank-2wyyho',
'minzoom': 18,
'layout': {
'text-field': [
'format',
['get', 'OBJECTID'], { 'font-scale': 0.9 },
'\n', {},
['get', 'BANKKVA'], { 'font-scale': 0.8 },
' KVA', { 'font-scale': 0.8 }
],
'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
'text-size': [
'interpolate',
['linear'],
['zoom'],
18, 14,  // At zoom 18, text size is 14 (was 9)
20, 18,  // At zoom 20, text size is 18 (was 12)
22, 24   // At zoom 22, text size is 24 (was 16)
],
'text-offset': [0, 2.5],
'text-anchor': 'top',
'text-allow-overlap': false,
'text-ignore-placement': false
},
'paint': {
'text-color': '#333333',
'text-halo-color': '#ffffff',
'text-halo-width': 2
}
});

// 7. Electric Meter Labels (appear at high zoom with larger dynamic sizing)
map.addLayer({
'id': 'meter-labels',
'type': 'symbol',
'source': 'meters',
'source-layer': 'electric_meters-5xjegj',
'minzoom': 19,
'layout': {
'text-field': ['get', 'MTRNUM'],
'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
'text-size': [
'interpolate',
['linear'],
['zoom'],
19, 12,  // At zoom 19, text size is 12 (was 8)
21, 16,  // At zoom 21, text size is 16 (was 11)
22, 20   // At zoom 22, text size is 20 (was 14)
],
'text-offset': [0, 2],
'text-anchor': 'top',
'text-allow-overlap': false,
'text-ignore-placement': false
},
'paint': {
'text-color': '#000000', // Black color
'text-halo-color': '#ffffff',
'text-halo-width': 2
}
});

// --- INTERACTIVITY ---
const popup = new mapboxgl.Popup({
closeButton: true,  // Enable close button
closeOnClick: false, // Don't close when clicking elsewhere on map
closeOnMove: false   // Don't close when moving the map
});

const createTransformerPopup = (e) => {
const properties = e.features[0].properties;
const coordinates = e.features[0].geometry.coordinates.slice();
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}

// ✅ CORRECTED PROPERTY NAMES
const popupHTML = `
       <h4>Transformer Details</h4>
       <p><strong>ID:</strong> ${properties.OBJECTID || 'N/A'}</p>
       <p><strong>FEEDER:</strong> ${properties.FEEDERID || 'N/A'}</p> 
       <p><strong>KVA:</strong> ${properties.KVA || 'N/A'}</p>
        <p><strong>TYPE:</strong> ${properties.TRANSFORMER || 'N/A'}</p> // should we add "STYLE"??
        <p><strong>TYPE:</strong> ${properties.TRANSFORMER || 'N/A'}</p> 
       <p><strong>COLOR:</strong> ${properties.COLOR || 'N/A'}</p>
       <a href="${properties.Link}" target="_blank">Open Audit Form &rarr;</a>
   `;
