<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Transformer Audit System</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 280px;
            z-index: 1000;
        }
        
        .layer-control {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .layer-control input {
            margin-right: 8px;
        }
        
        .layer-control label {
            font-size: 14px;
            cursor: pointer;
        }
        
        .popup-content {
            font-size: 14px;
            line-height: 1.4;
            max-width: 300px;
        }
        
        .audit-button {
            background: #007cbf;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            width: 100%;
        }
        
        .audit-button:hover {
            background: #005a8b;
        }
        
        .legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            font-size: 12px;
        }
        
        .legend-item {
            margin: 4px 0;
            display: flex;
            align-items: center;
        }
        
        .legend-symbol {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 50%;
        }
        
        .legend-line {
            width: 20px;
            height: 3px;
            margin-right: 8px;
        }
        
        .status-panel {
            background: #f8f9fa;
            padding: 8px;
            margin-top: 10px;
            border-radius: 3px;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    
    <div class='map-overlay'>
        <h3 style='margin: 0 0 15px 0;'>üîß Transformer Audit</h3>
        
        <div class='layer-control'>
            <input type='checkbox' id='transformer-toggle' checked>
            <label for='transformer-toggle'>üü† Transformer Banks</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='meters-toggle' checked>
            <label for='meters-toggle'>üîµ Electric Meters</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='secondary-oh-toggle' checked>
            <label for='secondary-oh-toggle'>üü¢ Secondary Overhead</label>
        </div>
        <div class='layer-control'>
            <input type='checkbox' id='secondary-ug-toggle' checked>
            <label for='secondary-ug-toggle'>üî¥ Secondary Underground</label>
        </div>
        
        <div class='status-panel' id='status-log'>
            <strong>Status:</strong> Loading...
        </div>
    </div>
    
    <div class='loading' id='loading'>
        <div>Loading utility data...</div>
        <div style='font-size: 12px; margin-top: 10px;'>This may take a moment</div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWUwZjA1ZXgwNGRhMmlvbHRscXk2NjVsIn0.VGVrTxKM9nEDk25TnFdcdg';
        
        const statusLog = document.getElementById('status-log');
        function updateStatus(message) {
            statusLog.innerHTML += '<br>' + message;
            statusLog.scrollTop = statusLog.scrollHeight;
            console.log(message);
        }

        // Initialize map with clean base style
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-77.88424798136592, 35.734696861467626],
            zoom: 16
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());

        map.on('load', function() {
            document.getElementById('loading').style.display = 'none';
            updateStatus('‚úÖ Map loaded');
            
            // Now we'll create a clean custom style by fetching your data and adding clean layers
            updateStatus('üì° Loading utility data...');
            
            // Get your custom style to extract the source configurations
            fetch('https://api.mapbox.com/styles/v1/fieldsense/cmdzysazb00hd01s9cm2v4td1?access_token=' + mapboxgl.accessToken)
                .then(response => response.json())
                .then(styleData => {
                    updateStatus('‚úÖ Style data retrieved');
                    
                    // Extract clean source definitions
                    if (styleData.sources) {
                        Object.keys(styleData.sources).forEach(sourceName => {
                            const source = styleData.sources[sourceName];
                            if (source.type === 'vector' && source.url) {
                                try {
                                    map.addSource(sourceName, {
                                        type: 'vector',
                                        url: source.url
                                    });
                                    updateStatus(`‚úÖ Added source: ${sourceName}`);
                                } catch (error) {
                                    updateStatus(`‚ùå Error adding source ${sourceName}: ${error.message}`);
                                }
                            }
                        });
                    }
                    
                    // Add clean, simple layers for your data
                    addCleanLayers();
                })
                .catch(error => {
                    updateStatus('‚ùå Error loading style: ' + error.message);
                    // Fallback: try adding sources directly
                    addSourcesDirectly();
                });
        });
        
        function addSourcesDirectly() {
            updateStatus('üîÑ Trying direct source loading...');
            
            const sources = [
                { id: 'transformers', tilesetId: 'fieldsense.9i382k93', name: 'Transformers' },
                { id: 'meters', tilesetId: 'fieldsense.00srtpq5', name: 'Meters' },
                { id: 'secondary-oh', tilesetId: 'fieldsense.0wvcayxk', name: 'Secondary OH' },
                { id: 'secondary-ug', tilesetId: 'fieldsense.cgp8b9gy', name: 'Secondary UG' }
            ];
            
            sources.forEach(source => {
                try {
                    map.addSource(source.id, {
                        type: 'vector',
                        url: `mapbox://${source.tilesetId}`
                    });
                    updateStatus(`‚úÖ Added ${source.name}`);
                } catch (error) {
                    updateStatus(`‚ùå Error adding ${source.name}: ${error.message}`);
                }
            });
            
            addCleanLayers();
        }
        
        function addCleanLayers() {
            updateStatus('üé® Adding clean layers...');
            
            // Try different source-layer names for each tileset
            const layerConfigs = [
                {
                    id: 'transformer-banks-layer',
                    source: 'transformers',
                    sourceLayerOptions: ['transformer_banks2', 'transformer-banks2', 'transformerbanks2', 'default'],
                    type: 'circle',
                    paint: {
                        'circle-radius': ['interpolate', ['linear'], ['zoom'], 12, 4, 16, 8, 20, 12],
                        'circle-color': '#ff6b35',
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 2,
                        'circle-opacity': 0.9
                    }
                },
                {
                    id: 'electric-meters-layer',
                    source: 'meters',
                    sourceLayerOptions: ['electric_meters2', 'electric-meters2', 'electricmeters2', 'default'],
                    type: 'circle',
                    paint: {
                        'circle-radius': ['interpolate', ['linear'], ['zoom'], 14, 2, 18, 6],
                        'circle-color': '#4a90e2',
                        'circle-opacity': 0.8
                    },
                    minzoom: 14
                },
                {
                    id: 'secondary-overhead-layer',
                    source: 'secondary-oh',
                    sourceLayerOptions: ['secondary_OH2', 'secondary-OH2', 'secondaryOH2', 'secondary_oh2', 'default'],
                    type: 'line',
                    paint: {
                        'line-color': '#2ecc71',
                        'line-width': ['interpolate', ['linear'], ['zoom'], 12, 1, 18, 3],
                        'line-opacity': 0.8
                    },
                    minzoom: 12
                },
                {
                    id: 'secondary-underground-layer',
                    source: 'secondary-ug',
                    sourceLayerOptions: ['secondary_UG2', 'secondary-UG2', 'secondaryUG2', 'secondary_ug2', 'default'],
                    type: 'line',
                    paint: {
                        'line-color': '#e74c3c',
                        'line-width': ['interpolate', ['linear'], ['zoom'], 12, 1, 18, 3],
                        'line-opacity': 0.8,
                        'line-dasharray': [2, 2]
                    },
                    minzoom: 12
                }
            ];
            
            layerConfigs.forEach(config => {
                let layerAdded = false;
                
                config.sourceLayerOptions.forEach(sourceLayer => {
                    if (layerAdded) return;
                    
                    try {
                        const layerDef = {
                            id: config.id,
                            type: config.type,
                            source: config.source,
                            'source-layer': sourceLayer,
                            paint: config.paint
                        };
                        
                        if (config.minzoom) layerDef.minzoom = config.minzoom;
                        
                        map.addLayer(layerDef);
                        
                        // Test if layer has data
                        setTimeout(() => {
                            try {
                                const features = map.querySourceFeatures(config.source, {
                                    sourceLayer: sourceLayer
                                });
                                
                                if (features && features.length > 0) {
                                    updateStatus(`‚úÖ ${config.id}: "${sourceLayer}" (${features.length} features)`);
                                    layerAdded = true;
                                } else {
                                    map.removeLayer(config.id);
                                }
                            } catch (e) {
                                if (map.getLayer(config.id)) {
                                    map.removeLayer(config.id);
                                }
                            }
                        }, 1000);
                        
                    } catch (error) {
                        // Layer add failed, try next source-layer name
                    }
                });
            });
            
            // Add click events to transformer layer
            setTimeout(() => {
                if (map.getLayer('transformer-banks-layer')) {
                    map.on('click', 'transformer-banks-layer', function(e) {
                        if (e.features && e.features.length > 0) {
                            const properties = e.features[0].properties;
                            
                            let popupContent = '<div class="popup-content">';
                            popupContent += '<h4>üîß Transformer Bank</h4>';
                            
                            // Show key properties
                            let propsShown = 0;
                            Object.keys(properties).forEach(key => {
                                if (propsShown < 6 && properties[key] !== null && properties[key] !== '' && properties[key] !== undefined) {
                                    popupContent += `<strong>${key}:</strong> ${properties[key]}<br>`;
                                    propsShown++;
                                }
                            });
                            
                            // Check for audit URL
                            const auditUrl = properties.audit_url || properties.form_url || properties.url || properties.AUDIT_URL;
                            
                            if (auditUrl) {
                                popupContent += `<button class="audit-button" onclick="window.open('${auditUrl}', '_blank')">Start Audit</button>`;
                            } else {
                                const assetId = properties.id || properties.objectid || properties.ID || 'unknown';
                                popupContent += `<button class="audit-button" onclick="startAudit('${assetId}')">Start Audit</button>`;
                            }
                            popupContent += '</div>';

                            new mapboxgl.Popup()
                                .setLngLat(e.lngLat)
                                .setHTML(popupContent)
                                .addTo(map);
                        }
                    });

                    map.on('mouseenter', 'transformer-banks-layer', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    map.on('mouseleave', 'transformer-banks-layer', () => {
                        map.getCanvas().style.cursor = '';
                    });
                }
            }, 2000);
            
            setupLayerToggles();
        }
        
        function setupLayerToggles() {
            const toggles = [
                { id: 'transformer-toggle', layer: 'transformer-banks-layer' },
                { id: 'meters-toggle', layer: 'electric-meters-layer' },
                { id: 'secondary-oh-toggle', layer: 'secondary-overhead-layer' },
                { id: 'secondary-ug-toggle', layer: 'secondary-underground-layer' }
            ];
            
            toggles.forEach(toggle => {
                const checkbox = document.getElementById(toggle.id);
                if (checkbox) {
                    checkbox.addEventListener('change', (e) => {
                        if (map.getLayer(toggle.layer)) {
                            map.setLayoutProperty(toggle.layer, 'visibility', 
                                e.target.checked ? 'visible' : 'none');
                        }
                    });
                }
            });
        }
        
        function startAudit(assetId) {
            alert(`Starting audit for asset: ${assetId}\n\nThis will redirect to your audit form once URLs are embedded in the data.`);
        }
        
        // Error handling
        map.on('error', (e) => {
            updateStatus('‚ùå ' + e.error.message);
        });
    </script>
</body>
</html>
