<!DOCTYPE html>
<html>
<head>
    <title>Transformer Audit Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .legend {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 24px;
            color: #555;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-symbol {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #333;
        }
        .transformer-symbol { background-color: #FF5733; border-radius: 50%; }
        .meter-symbol { background-color: #3388FF; border-radius: 50%; }
        .underground-symbol { background-color: #FFC300; height: 5px; border: none; }
        .overhead-symbol { background-color: #4CAF50; height: 5px; border: none; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    var map = L.map('map').setView([35.732, -77.923], 13); // Centered on Wilson, NC

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Layer groups
    var transformerLayer = L.layerGroup().addTo(map);
    var meterLayer = L.layerGroup().addTo(map);
    var undergroundLayer = L.layerGroup().addTo(map);
    var overheadLayer = L.layerGroup().addTo(map);

    // FIX: 1. Initialize counters for features and file loading tracking
    var totalTransformers = 0;
    var totalMeters = 0;
    var totalUnderground = 0;
    var totalOverhead = 0;
    var filesToProcess = 4;
    var filesProcessed = 0;

    // Fetch and parse TRANSFORMER.csv
    Papa.parse('https://raw.githubusercontent.com/gverag/webmap/main/TRANSFORMER.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        step: function(row) {
            var data = row.data;
            // FIX: 2. Only add transformers if their status is NOT "Completed"
            if (data.Latitude && data.Longitude && data.Status !== 'Completed') {
                var marker = L.circleMarker([data.Latitude, data.Longitude], {
                    radius: 8,
                    fillColor: "#FF5733",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(transformerLayer);

                marker.bindPopup(
                    "<b>Transformer ID:</b> " + data.TransformerID + "<br>" +
                    "<b>Status:</b> " + data.Status + "<br>" +
                    "<b>Audit Form:</b> <a href='" + data.AuditForm + "' target='_blank'>Open Form</a>"
                );
                totalTransformers++; // Increment counter
            }
        },
        complete: function() {
            console.log("Transformers loaded.");
            // FIX: 3. Check if all files are processed to update the legend
            filesProcessed++;
            if (filesProcessed === filesToProcess) {
                updateFinalLegendCounts();
            }
        }
    });

    // Fetch and parse METER.csv
    Papa.parse('https://raw.githubusercontent.com/gverag/webmap/main/METER.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        step: function(row) {
            var data = row.data;
             // FIX: 2. Only add meters if their status is NOT "Completed"
            if (data.Latitude && data.Longitude && data.Status !== 'Completed') {
                var marker = L.circleMarker([data.Latitude, data.Longitude], {
                    radius: 6,
                    fillColor: "#3388FF",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(meterLayer);

                marker.bindPopup(
                    "<b>Meter ID:</b> " + data.MeterID + "<br>" +
                    "<b>Transformer ID:</b> " + data.TransformerID + "<br>" +
                    "<b>Status:</b> " + data.Status
                );
                totalMeters++; // Increment counter
            }
        },
        complete: function() {
            console.log("Meters loaded.");
            // FIX: 3. Check if all files are processed to update the legend
            filesProcessed++;
            if (filesProcessed === filesToProcess) {
                updateFinalLegendCounts();
            }
        }
    });

    // Fetch and parse UNDERGROUND_FEEDER.csv
    Papa.parse('https://raw.githubusercontent.com/gverag/webmap/main/UNDERGROUND_FEEDER.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        step: function(row) {
            var data = row.data;
            // FIX: 2. Only add feeders if their status is NOT "Completed"
            if (data.StartLat && data.StartLon && data.EndLat && data.EndLon && data.Status !== 'Completed') {
                var latlngs = [
                    [data.StartLat, data.StartLon],
                    [data.EndLat, data.EndLon]
                ];
                L.polyline(latlngs, { color: '#FFC300', weight: 5 }).addTo(undergroundLayer);
                totalUnderground++; // Increment counter
            }
        },
        complete: function() {
            console.log("Underground feeders loaded.");
            // FIX: 3. Check if all files are processed to update the legend
            filesProcessed++;
            if (filesProcessed === filesToProcess) {
                updateFinalLegendCounts();
            }
        }
    });

    // Fetch and parse OVERHEAD_FEEDER.csv
    Papa.parse('https://raw.githubusercontent.com/gverag/webmap/main/OVERHEAD_FEEDER.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        step: function(row) {
            var data = row.data;
            // FIX: 2. Only add feeders if their status is NOT "Completed"
            if (data.StartLat && data.StartLon && data.EndLat && data.EndLon && data.Status !== 'Completed') {
                var latlngs = [
                    [data.StartLat, data.StartLon],
                    [data.EndLat, data.EndLon]
                ];
                L.polyline(latlngs, { color: '#4CAF50', weight: 5, dashArray: '10, 5' }).addTo(overheadLayer);
                totalOverhead++; // Increment counter
            }
        },
        complete: function() {
            console.log("Overhead feeders loaded.");
            // FIX: 3. Check if all files are processed to update the legend
            filesProcessed++;
            if (filesProcessed === filesToProcess) {
                updateFinalLegendCounts();
            }
        }
    });

    // Legend control
    var legend = L.control({position: 'topleft'});

    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML += '<h4>Asset Legend</h4>';
        div.innerHTML += '<div class="legend-item"><div class="legend-symbol transformer-symbol"></div>Transformers: <span id="transformer-count">0</span></div>';
        div.innerHTML += '<div class="legend-item"><div class="legend-symbol meter-symbol"></div>Meters: <span id="meter-count">0</span></div>';
        div.innerHTML += '<div class="legend-item"><div class="legend-symbol underground-symbol"></div>Underground: <span id="underground-count">0</span></div>';
        div.innerHTML += '<div class="legend-item"><div class="legend-symbol overhead-symbol"></div>Overhead: <span id="overhead-count">0</span></div>';
        return div;
    };
    legend.addTo(map);

    // FIX: 4. Create a new function to update the legend with the final, static counts
    function updateFinalLegendCounts() {
        console.log("All files processed. Updating legend.");
        document.getElementById('transformer-count').innerHTML = totalTransformers;
        document.getElementById('meter-count').innerHTML = totalMeters;
        document.getElementById('underground-count').innerHTML = totalUnderground;
        document.getElementById('overhead-count').innerHTML = totalOverhead;
    }

    // Layer control
    var overlayMaps = {
        "Transformers": transformerLayer,
        "Meters": meterLayer,
        "Underground Feeders": undergroundLayer,
        "Overhead Feeders": overheadLayer
    };
    L.control.layers(null, overlayMaps).addTo(map);

</script>

</body>
</html>
