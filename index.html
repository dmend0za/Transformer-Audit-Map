<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Transformer Audit System - Debug</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            font-size: 14px;
        }
        
        .debug-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .status-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .test-button {
            background: #007cbf;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        
        .test-button:hover {
            background: #005a8b;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    
    <div class='debug-panel'>
        <h3>🔧 Debug Panel</h3>
        <div id='status-log'></div>
        <div style='margin-top: 15px;'>
            <button class='test-button' onclick='testCustomStyle()'>Test Custom Style</button>
            <button class='test-button' onclick='testTokenAccess()'>Test Token</button>
        </div>
    </div>

    <script>
        // Set token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWUwZjA1ZXgwNGRhMmlvbHRscXk2NjVsIn0.VGVrTxKM9nEDk25TnFdcdg';
        
        const statusLog = document.getElementById('status-log');
        
        function addStatus(message, type = 'info') {
            const statusItem = document.createElement('div');
            statusItem.className = `status-item status-${type}`;
            statusItem.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            statusLog.appendChild(statusItem);
            statusLog.scrollTop = statusLog.scrollHeight;
            console.log(message);
        }

        // Test basic Mapbox GL JS functionality first
        addStatus('🔍 Testing Mapbox GL JS...', 'info');
        
        if (typeof mapboxgl === 'undefined') {
            addStatus('❌ Mapbox GL JS not loaded', 'error');
        } else {
            addStatus('✅ Mapbox GL JS loaded successfully', 'success');
            addStatus(`Version: ${mapboxgl.version}`, 'info');
        }

        // Test WebGL support
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (gl) {
            addStatus('✅ WebGL is supported', 'success');
        } else {
            addStatus('❌ WebGL is not supported - this may cause issues', 'error');
        }

        // Initialize map with minimal configuration
        let map;
        
        try {
            addStatus('🗺️ Initializing basic map...', 'info');
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11', // Simple style
                center: [-77.88424798136592, 35.734696861467626],
                zoom: 10
            });

            map.on('load', function() {
                addStatus('✅ Basic map loaded successfully', 'success');
            });

            map.on('error', function(e) {
                addStatus(`❌ Map error: ${e.error.message}`, 'error');
            });

        } catch (error) {
            addStatus(`❌ Failed to initialize map: ${error.message}`, 'error');
        }

        // Function to test custom style
        function testCustomStyle() {
            addStatus('🔍 Testing custom style access...', 'info');
            
            const styleUrl = 'https://api.mapbox.com/styles/v1/fieldsense/cmdzysazb00hd01s9cm2v4td1';
            
            fetch(`${styleUrl}?access_token=${mapboxgl.accessToken}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                })
                .then(styleData => {
                    addStatus('✅ Custom style is accessible', 'success');
                    addStatus(`Style has ${styleData.layers ? styleData.layers.length : 0} layers`, 'info');
                    
                    if (styleData.sources) {
                        const sourceNames = Object.keys(styleData.sources);
                        addStatus(`Sources: ${sourceNames.join(', ')}`, 'info');
                    }
                    
                    // Try to apply the custom style
                    if (map && map.isStyleLoaded()) {
                        addStatus('🔄 Applying custom style to map...', 'info');
                        try {
                            map.setStyle(`mapbox://styles/fieldsense/cmdzysazb00hd01s9cm2v4td1`);
                            
                            map.once('styledata', function() {
                                addStatus('✅ Custom style applied successfully', 'success');
                                
                                // List available layers
                                const layers = map.getStyle().layers;
                                addStatus(`Map now has ${layers.length} layers`, 'info');
                                
                                layers.forEach(layer => {
                                    if (layer.source && typeof layer.source === 'string' && layer.source.includes('fieldsense')) {
                                        addStatus(`Data layer found: ${layer.id} (${layer.type})`, 'success');
                                    }
                                });
                            });
                            
                        } catch (styleError) {
                            addStatus(`❌ Error applying custom style: ${styleError.message}`, 'error');
                        }
                    }
                })
                .catch(error => {
                    addStatus(`❌ Cannot access custom style: ${error.message}`, 'error');
                });
        }

        // Function to test token access
        function testTokenAccess() {
            addStatus('🔍 Testing token permissions...', 'info');
            
            // Test basic token validity
            fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/test.json?access_token=${mapboxgl.accessToken}&limit=1`)
                .then(response => {
                    if (response.ok) {
                        addStatus('✅ Token is valid for basic API access', 'success');
                    } else {
                        addStatus(`❌ Token validation failed: ${response.status}`, 'error');
                    }
                })
                .catch(error => {
                    addStatus(`❌ Token test error: ${error.message}`, 'error');
                });
        }

        // Auto-run initial tests
        setTimeout(() => {
            if (map) {
                testTokenAccess();
            }
        }, 2000);
    </script>
</body>
</html>
