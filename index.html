<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transformer Audit Map</title>
<!-- Mapbox GL JS CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<!-- Mapbox GL JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
/* Basic styling for the body and map container */
body {
margin: 0;
padding: 0;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

#map {
position: absolute;
top: 0;
bottom: 0;
width: 100%;
}

#legend {
position: absolute;
top: 20px;
left: 20px;
background: rgba(255, 255, 255, 0.95);
padding: 15px;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
z-index: 1000;
font-size: 14px;
min-width: 200px;
border: 1px solid #ccc;
}

#legend h3 {
margin: 0 0 10px 0;
color: #333;
font-size: 16px;
font-weight: 600;
}

.legend-item {
display: flex;
justify-content: space-between;
align-items: center;
margin: 8px 0;
padding: 4px 0;
}

.legend-symbol {
width: 16px;
height: 16px;
margin-right: 8px;
border: 1px solid #000;
display: inline-block;
}

.legend-symbol.underground {
background-color: #4CAF50;
}

.legend-symbol.overhead {
background-color: hsl(123, 7%, 85%);
border-radius: 50%;
}

.legend-symbol.meter {
background-color: #555555;
border: 1px solid #fff;
border-radius: 50%;
}

.legend-count {
font-weight: 600;
color: #333;
}

.status-pending { color: #ff6b35; }
.status-inprogress { color: #ffc107; }
.status-completed { color: #28a745; }

/* Unsupported browser message */
#unsupported {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: #f8f9fa;
display: none;
flex-direction: column;
justify-content: center;
align-items: center;
text-align: center;
padding: 20px;
box-sizing: border-box;
}

#unsupported h2 {
color: #dc3545;
margin-bottom: 20px;
}

#unsupported p {
color: #6c757d;
max-width: 500px;
line-height: 1.5;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="legend">
<h3>Audit Status</h3>
<div class="legend-item">
<span><span class="legend-symbol underground"></span>Underground Feeders</span>
<span class="legend-count" id="underground-count">0</span>
</div>
<div class="legend-item">
<span><span class="legend-symbol overhead"></span>Overhead Feeders</span>
<span class="legend-count" id="overhead-count">0</span>
</div>
<div class="legend-item">
<span><span class="legend-symbol meter"></span>Electric Meters</span>
<span class="legend-count" id="meter-count">0</span>
</div>
</div>

<div id="unsupported">
<h2>WebGL Not Supported</h2>
<p>Your browser does not support WebGL, which is required for this map application. Please update your browser or use a different browser that supports WebGL.</p>
</div>

<script>
// Store original data for legend counting
let originalData = {
transformers: null,
meters: null,
undergroundFeeders: null,
overheadFeeders: null
};

// Check if the browser supports WebGL
if (mapboxgl.supported()) {
// Set your Mapbox access token here
mapboxgl.accessToken = 'pk.eyJ1IjoiY2hyaXN0b3BoZXJjb3giLCJhIjoiY2tvcmNmczF0MDFwZzJvcW83eGNvdWI0ZCJ9.lSeUOEpUOBhL41GL1oiB0g';

// Initialize the map
const map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/satellite-v9',
center: [-80.8431, 35.2271],
zoom: 12
});

// Function to filter out completed items
function filterCompletedItems(features) {
return features.filter(feature => {
const status = feature.properties.Status || feature.properties.status;
return status !== 'Completed' && status !== 'completed';
});
}

// Function to update legend counts based on original data (not filtered by zoom)
function updateLegendCounts() {
if (!originalData.transformers || !originalData.meters || 
    !originalData.undergroundFeeders || !originalData.overheadFeeders) {
return;
}

// Filter out completed items from original data
const activeTransformers = filterCompletedItems(originalData.transformers.features);
const activeMeters = filterCompletedItems(originalData.meters.features);
const activeUnderground = filterCompletedItems(originalData.undergroundFeeders.features);
const activeOverhead = filterCompletedItems(originalData.overheadFeeders.features);

// Update legend counts
document.getElementById('underground-count').textContent = activeUnderground.length;
document.getElementById('overhead-count').textContent = activeOverhead.length;
document.getElementById('meter-count').textContent = activeMeters.length;
}

// Function to create transformer popup
function createTransformerPopup(e) {
const coordinates = e.features[0].geometry.coordinates.slice();
const properties = e.features[0].properties;

// Ensure that if the map is zoomed out such that multiple
// copies of the feature are visible, the popup appears
// over the copy being pointed to.
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}

const popupContent = `
<div style="font-family: Arial, sans-serif; max-width: 300px;">
<h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">Transformer ${properties.DEVICENAME || 'N/A'}</h3>
<div style="margin: 5px 0;"><strong>Location ID:</strong> ${properties.LOCATIONID || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Feeder:</strong> ${properties.FEEDER || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Substation:</strong> ${properties.SUBSTATION || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Install Date:</strong> ${properties.INSTALLDATE || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Status:</strong> 
<span class="status-${(properties.Status || 'pending').toLowerCase()}">${properties.Status || 'Pending'}</span>
</div>
</div>
`;

new mapboxgl.Popup({ closeOnClick: true, closeOnMove: false })
.setLngLat(coordinates)
.setHTML(popupContent)
.addTo(map);
}

// Function to create meter popup
function createMeterPopup(e) {
const coordinates = e.features[0].geometry.coordinates.slice();
const properties = e.features[0].properties;

// Ensure that if the map is zoomed out such that multiple
// copies of the feature are visible, the popup appears
// over the copy being pointed to.
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}

const popupContent = `
<div style="font-family: Arial, sans-serif; max-width: 300px;">
<h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">Electric Meter</h3>
<div style="margin: 5px 0;"><strong>Account:</strong> ${properties.ACCOUNTNO || properties.Account || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Address:</strong> ${properties.ADDRESS || properties.Address || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Customer:</strong> ${properties.CUSTOMER || properties.Customer || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Transformer:</strong> ${properties.TRANSFORMER || properties.Transformer || 'N/A'}</div>
<div style="margin: 5px 0;"><strong>Status:</strong> 
<span class="status-${(properties.Status || 'pending').toLowerCase()}">${properties.Status || 'Pending'}</span>
</div>
</div>
`;

new mapboxgl.Popup({ closeOnClick: true, closeOnMove: false })
.setLngLat(coordinates)
.setHTML(popupContent)
.addTo(map);
}

map.on('load', () => {
// Load all data sources
Promise.all([
fetch('https://raw.githubusercontent.com/christophercox-cec/FieldAuditApp/main/transformers.geojson'),
fetch('https://raw.githubusercontent.com/christophercox-cec/FieldAuditApp/main/meters.geojson'),
fetch('https://raw.githubusercontent.com/christophercox-cec/FieldAuditApp/main/underground_feeders.geojson'),
fetch('https://raw.githubusercontent.com/christophercox-cec/FieldAuditApp/main/overhead_feeders.geojson')
]).then(responses => {
return Promise.all(responses.map(response => response.json()));
}).then(([transformersData, metersData, undergroundFeedersData, overheadFeedersData]) => {
// Store original data for legend counting
originalData.transformers = transformersData;
originalData.meters = metersData;
originalData.undergroundFeeders = undergroundFeedersData;
originalData.overheadFeeders = overheadFeedersData;

// Filter out completed items for display
const activeTransformers = {
...transformersData,
features: filterCompletedItems(transformersData.features)
};
const activeMeters = {
...metersData,
features: filterCompletedItems(metersData.features)
};
const activeUndergroundFeeders = {
...undergroundFeedersData,
features: filterCompletedItems(undergroundFeedersData.features)
};
const activeOverheadFeeders = {
...overheadFeedersData,
features: filterCompletedItems(overheadFeedersData.features)
};

// Add data sources with filtered data
map.addSource('transformers-source', {
type: 'geojson',
data: activeTransformers
});

map.addSource('meters-source', {
type: 'geojson',
data: activeMeters
});

map.addSource('underground-feeders-source', {
type: 'geojson',
data: activeUndergroundFeeders
});

map.addSource('overhead-feeders-source', {
type: 'geojson',
data: activeOverheadFeeders
});

// Add underground feeders layer (lines)
map.addLayer({
id: 'underground-feeders',
type: 'line',
source: 'underground-feeders-source',
layout: {
'line-join': 'round',
'line-cap': 'round'
},
paint: {
'line-color': '#4CAF50',
'line-width': 3,
'line-opacity': 0.8
}
});

// Add overhead feeders layer (lines)
map.addLayer({
id: 'overhead-feeders',
type: 'line',
source: 'overhead-feeders-source',
layout: {
'line-join': 'round',
'line-cap': 'round'
},
paint: {
'line-color': 'hsl(123, 7%, 85%)',
'line-width': 3,
'line-opacity': 0.8
}
});

// Add transformers underground layer
map.addLayer({
id: 'transformers-underground',
type: 'circle',
source: 'transformers-source',
filter: ['==', 'MOUNTEDTYPE', 'Underground'],
paint: {
'circle-radius': {
base: 1.75,
stops: [
[12, 8],
[22, 180]
]
},
'circle-color': '#4CAF50',
'circle-stroke-width': 2,
'circle-stroke-color': '#ffffff'
}
});

// Add transformers overhead layer
map.addLayer({
id: 'transformers-overhead',
type: 'circle',
source: 'transformers-source',
filter: ['==', 'MOUNTEDTYPE', 'Overhead'],
paint: {
'circle-radius': {
base: 1.75,
stops: [
[12, 8],
[22, 180]
]
},
'circle-color': 'hsl(123, 7%, 85%)',
'circle-stroke-width': 2,
'circle-stroke-color': '#000000'
}
});

// Add electric meters layer
map.addLayer({
id: 'electric-meters',
type: 'circle',
source: 'meters-source',
paint: {
'circle-radius': {
base: 1.75,
stops: [
[12, 4],
[22, 90]
]
},
'circle-color': '#555555',
'circle-stroke-width': 1,
'circle-stroke-color': '#ffffff'
}
});

// Add transformer labels
map.addLayer({
id: 'transformer-labels',
type: 'symbol',
source: 'transformers-source',
layout: {
'text-field': ['get', 'DEVICENAME'],
'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
'text-size': 10,
'text-offset': [0, 1.5],
'text-anchor': 'top',
'text-optional': true
},
paint: {
'text-color': '#ffffff',
'text-halo-color': '#000000',
'text-halo-width': 1
},
minzoom: 16
});

// Add meter labels
map.addLayer({
id: 'meter-labels',
type: 'symbol',
source: 'meters-source',
layout: {
'text-field': ['get', 'ACCOUNTNO'],
'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
'text-size': 8,
'text-offset': [0, 1.2],
'text-anchor': 'top',
'text-optional': true
},
paint: {
'text-color': '#ffffff',
'text-halo-color': '#000000',
'text-halo-width': 1
},
minzoom: 18
});

// Update legend counts after all data is loaded
updateLegendCounts();

// Add click handlers for interactive layers
const interactiveLayers = [
'transformers-underground',
'transformers-overhead',
'electric-meters',
'transformer-labels',
'meter-labels'
];

interactiveLayers.forEach(layerId => {
map.on('click', layerId, (e) => {
if (layerId.includes('transformer')) {
createTransformerPopup(e);
} else if (layerId.includes('meter')) {
createMeterPopup(e);
}
});

map.on('mouseenter', layerId, () => {
map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', layerId, () => {
map.getCanvas().style.cursor = '';
// Don't remove popup on mouseleave - let user interact with it
});
});

}).catch(error => {
console.error('Error loading data:', error);
});

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl());
});

} else {
// If WebGL is not supported, hide the map and show the error message.
document.getElementById('map').style.display = 'none';
document.getElementById('unsupported').style.display = 'flex';
}
</script>

</body>
</html>
