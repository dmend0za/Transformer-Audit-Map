<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Transformer Audit System</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            z-index: 1000;
        }
        
        .layer-control {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .layer-control input {
            margin-right: 8px;
        }
        
        .layer-control label {
            font-size: 14px;
            cursor: pointer;
        }
        
        .layer-control.disabled {
            opacity: 0.5;
        }
        
        .popup-content {
            font-size: 14px;
            line-height: 1.4;
            max-width: 300px;
        }
        
        .audit-button {
            background: #007cbf;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            width: 100%;
        }
        
        .audit-button:hover {
            background: #005a8b;
        }
        
        .status-panel {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        
        .status-success { color: #155724; }
        .status-error { color: #721c24; }
        .status-warning { color: #856404; }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    
    <div class='map-overlay'>
        <h3 style='margin: 0 0 15px 0; color: #333;'>‚ö° Transformer Audit</h3>
        
        <div class='layer-control' id='transformer-control'>
            <input type='checkbox' id='transformer-toggle' checked>
            <label for='transformer-toggle'>üü† Transformer Banks</label>
        </div>
        <div class='layer-control' id='meters-control'>
            <input type='checkbox' id='meters-toggle' checked>
            <label for='meters-toggle'>üîµ Electric Meters</label>
        </div>
        <div class='layer-control' id='secondary-oh-control'>
            <input type='checkbox' id='secondary-oh-toggle' checked>
            <label for='secondary-oh-toggle'>üü¢ Secondary Overhead</label>
        </div>
        <div class='layer-control' id='secondary-ug-control'>
            <input type='checkbox' id='secondary-ug-toggle' checked>
            <label for='secondary-ug-toggle'>üî¥ Secondary Underground</label>
        </div>
        
        <div class='status-panel' id='status-log'>
            <strong>Loading Status:</strong><br>
            Initializing map...
        </div>
    </div>
    
    <div class='loading' id='loading'>
        <div>üó∫Ô∏è Loading Utility Infrastructure</div>
        <div style='font-size: 12px; margin-top: 10px; opacity: 0.8;'>Connecting to available data...</div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWUwZjA1ZXgwNGRhMmlvbHRscXk2NjVsIn0.VGVrTxKM9nEDk25TnFdcdg';
        
        const statusLog = document.getElementById('status-log');
        const availableLayers = {};
        
        function updateStatus(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            let className = '';
            if (type === 'success') className = 'status-success';
            else if (type === 'error') className = 'status-error';
            else if (type === 'warning') className = 'status-warning';
            
            statusLog.innerHTML += `<br><span class="${className}">${timestamp}: ${message}</span>`;
            statusLog.scrollTop = statusLog.scrollHeight;
            console.log(message);
        }

        // Initialize map with satellite view
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-77.88424798136592, 35.734696861467626],
            zoom: 16
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

        map.on('load', function() {
            document.getElementById('loading').style.display = 'none';
            updateStatus('‚úÖ Base map loaded', 'success');
            
            // Test and load each tileset individually
            loadTilesetSafely();
        });

        function loadTilesetSafely() {
            updateStatus('üì° Testing tileset availability...', 'info');
            
            const tilesetConfigs = [
                { 
                    id: 'transformers-src',
                    tilesetId: 'fieldsense.9i382k93',
                    name: 'Transformers',
                    layerId: 'transformers-layer',
                    controlId: 'transformer-control',
                    sourceLayerCandidates: ['transformer_banks2', 'transformer-banks2', 'transformerbanks2', 'default'],
                    style: {
                        type: 'circle',
                        paint: {
                            'circle-radius': ['interpolate', ['linear'], ['zoom'], 12, 5, 16, 8, 20, 12],
                            'circle-color': '#ff6b35',
                            'circle-stroke-color': '#ffffff',
                            'circle-stroke-width': 2,
                            'circle-opacity': 0.9
                        }
                    }
                },
                { 
                    id: 'meters-src',
                    tilesetId: 'fieldsense.00srtpq5',
                    name: 'Meters',
                    layerId: 'meters-layer',
                    controlId: 'meters-control',
                    sourceLayerCandidates: ['electric_meters2', 'electric-meters2', 'electricmeters2', 'default'],
                    style: {
                        type: 'circle',
                        paint: {
                            'circle-radius': ['interpolate', ['linear'], ['zoom'], 14, 2, 18, 6],
                            'circle-color': '#4a90e2',
                            'circle-opacity': 0.8
                        },
                        minzoom: 14
                    }
                },
                { 
                    id: 'secondary-oh-src',
                    tilesetId: 'fieldsense.0wvcayxk',
                    name: 'Secondary OH',
                    layerId: 'secondary-oh-layer',
                    controlId: 'secondary-oh-control',
                    sourceLayerCandidates: ['secondary_OH2', 'secondary-OH2', 'secondaryOH2', 'secondary_oh2', 'default'],
                    style: {
                        type: 'line',
                        paint: {
                            'line-color': '#2ecc71',
                            'line-width': ['interpolate', ['linear'], ['zoom'], 12, 1.5, 18, 4],
                            'line-opacity': 0.8
                        },
                        minzoom: 12
                    }
                },
                { 
                    id: 'secondary-ug-src',
                    tilesetId: 'fieldsense.cgp8b9gy',
                    name: 'Secondary UG',
                    layerId: 'secondary-ug-layer',
                    controlId: 'secondary-ug-control',
                    sourceLayerCandidates: ['secondary_UG2', 'secondary-UG2', 'secondaryUG2', 'secondary_ug2', 'default'],
                    style: {
                        type: 'line',
                        paint: {
                            'line-color': '#e74c3c',
                            'line-width': ['interpolate', ['linear'], ['zoom'], 12, 1.5, 18, 4],
                            'line-opacity': 0.8,
                            'line-dasharray': [3, 2]
                        },
                        minzoom: 12
                    }
                }
            ];

            // Test each tileset by trying to fetch its metadata
            tilesetConfigs.forEach((config, index) => {
                setTimeout(() => {
                    testAndLoadTileset(config);
                }, index * 500); // Stagger the requests
            });
        }

        function testAndLoadTileset(config) {
            updateStatus(`üîç Testing ${config.name}...`, 'info');
            
            // Test tileset availability by fetching its JSON metadata
            fetch(`https://api.mapbox.com/v4/${config.tilesetId}.json?access_token=${mapboxgl.accessToken}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error(`HTTP ${response.status}`);
                })
                .then(metadata => {
                    updateStatus(`‚úÖ ${config.name} tileset found`, 'success');
                    loadTilesetData(config);
                })
                .catch(error => {
                    updateStatus(`‚ùå ${config.name} not accessible (${error.message})`, 'error');
                    disableLayerControl(config.controlId);
                });
        }

        function loadTilesetData(config) {
            try {
                // Add the source
                map.addSource(config.id, {
                    type: 'vector',
                    url: `mapbox://${config.tilesetId}`
                });
                updateStatus(`üì• Added ${config.name} source`, 'success');
                
                // Try different source-layer names
                let layerCreated = false;
                config.sourceLayerCandidates.forEach((sourceLayer, index) => {
                    if (layerCreated) return;
                    
                    setTimeout(() => {
                        if (layerCreated) return;
                        
                        try {
                            const layerDef = {
                                id: config.layerId,
                                type: config.style.type,
                                source: config.id,
                                'source-layer': sourceLayer,
                                paint: config.style.paint
                            };
                            
                            if (config.style.minzoom) layerDef.minzoom = config.style.minzoom;
                            
                            map.addLayer(layerDef);
                            
                            // Test if layer has features
                            setTimeout(() => {
                                try {
                                    const features = map.querySourceFeatures(config.id, {
                                        sourceLayer: sourceLayer
                                    });
                                    
                                    if (features && features.length > 0) {
                                        updateStatus(`‚úÖ ${config.name}: ${features.length} features loaded`, 'success');
                                        availableLayers[config.layerId] = config;
                                        layerCreated = true;
                                        
                                        // Setup interactions for transformers
                                        if (config.id === 'transformers-src') {
                                            setupTransformerInteractions(config.layerId);
                                        }
                                        
                                        setupLayerToggle(config);
                                    } else {
                                        updateStatus(`‚ö†Ô∏è ${config.name}: No features found with "${sourceLayer}"`, 'warning');
                                        if (map.getLayer(config.layerId)) {
                                            map.removeLayer(config.layerId);
                                        }
                                    }
                                } catch (queryError) {
                                    if (map.getLayer(config.layerId)) {
                                        map.removeLayer(config.layerId);
                                    }
                                }
                            }, 1000);
                            
                        } catch (layerError) {
                            // This source-layer name didn't work, try the next one
                        }
                    }, index * 300);
                });
                
            } catch (sourceError) {
                updateStatus(`‚ùå Failed to add ${config.name} source: ${sourceError.message}`, 'error');
                disableLayerControl(config.controlId);
            }
        }

        function setupTransformerInteractions(layerId) {
            map.on('click', layerId, function(e) {
                const properties = e.features[0].properties;
                
                let popupContent = '<div class="popup-content">';
                popupContent += '<h4>üîß Transformer Bank</h4>';
                
                // Display key properties
                let propsShown = 0;
                Object.keys(properties).forEach(key => {
                    if (propsShown < 5 && properties[key] !== null && properties[key] !== '' && properties[key] !== undefined) {
                        popupContent += `<strong>${key}:</strong> ${properties[key]}<br>`;
                        propsShown++;
                    }
                });
                
                // Look for audit URL
                const auditUrl = properties.audit_url || properties.form_url || properties.url || 
                               properties.AUDIT_URL || properties.FORM_URL || properties.URL;
                
                if (auditUrl) {
                    popupContent += `<button class="audit-button" onclick="window.open('${auditUrl}', '_blank')">Start Audit</button>`;
                } else {
                    const assetId = properties.id || properties.objectid || properties.ID || properties.OBJECTID || 'unknown';
                    popupContent += `<button class="audit-button" onclick="startAudit('${assetId}')">Start Audit</button>`;
                }
                popupContent += '</div>';

                new mapboxgl.Popup({ closeOnClick: true })
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    .addTo(map);
            });

            map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
            });

            updateStatus('‚úÖ Transformer click events ready', 'success');
        }

        function setupLayerToggle(config) {
            const toggle = document.getElementById(config.controlId.replace('-control', '-toggle'));
            if (toggle) {
                toggle.addEventListener('change', function(e) {
                    if (map.getLayer(config.layerId)) {
                        map.setLayoutProperty(config.layerId, 'visibility', 
                            e.target.checked ? 'visible' : 'none');
                    }
                });
            }
        }

        function disableLayerControl(controlId) {
            const control = document.getElementById(controlId);
            if (control) {
                control.classList.add('disabled');
                const checkbox = control.querySelector('input');
                if (checkbox) {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                }
            }
        }

        function startAudit(assetId) {
            alert(`üîß Starting audit for transformer: ${assetId}\n\nThis will redirect to your audit form once URLs are embedded in the transformer data.`);
        }

        // Error handling
        map.on('error', function(e) {
            updateStatus(`‚ùå Map error: ${e.error.message}`, 'error');
        });

        // Final status update
        setTimeout(() => {
            const loadedCount = Object.keys(availableLayers).length;
            if (loadedCount > 0) {
                updateStatus(`üéØ Map ready! ${loadedCount} layer(s) loaded successfully`, 'success');
            } else {
                updateStatus('‚ö†Ô∏è No data layers could be loaded. Check tileset availability.', 'warning');
            }
        }, 5000);
    </script>
</body>
</html>
