<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug MapBox Style Access</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #debug-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>MapBox Style Access Debug Tool</h1>
    
    <div id="debug-info">
        <h3>Testing Your Style Access</h3>
        <p><strong>Your Style ID:</strong> mapbox://styles/fieldsense/cmdzysazb00hd01s9cm2v4td1</p>
        <p><strong>Your Token:</strong> pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWMwb2ljY3YwNGFoMnJvaXN5c2xnMnR6In0.wc3C3TrsgsfyLf5ZJqHpnA</p>
        
        <button class="test-button" onclick="testStyleAccess()">Test Style Access</button>
        <button class="test-button" onclick="testWithFallback()">Try with Fallback Style</button>
        <button class="test-button" onclick="testLayerDiscovery()">Test Layer Discovery</button>
        
        <div id="test-results"></div>
    </div>

    <div id="map"></div>

    <script>
        const accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWMwb2ljY3YwNGFoMnJvaXN5c2xnMnR6In0.wc3C3TrsgsfyLf5ZJqHpnA';
        const customStyleUrl = 'mapbox://styles/fieldsense/cmdzysazb00hd01s9cm2v4td1';
        const resultsDiv = document.getElementById('test-results');
        
        mapboxgl.accessToken = accessToken;
        let map;

        function addResult(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        async function testStyleAccess() {
            resultsDiv.innerHTML = '<p>Testing style access...</p>';
            
            try {
                // Test direct API access to style
                const response = await fetch(`https://api.mapbox.com/styles/v1/fieldsense/cmdzysazb00hd01s9cm2v4td1?access_token=${accessToken}`);
                
                if (response.ok) {
                    const styleData = await response.json();
                    addResult(`✅ Style is accessible! Name: ${styleData.name || 'Unnamed'}`);
                    console.log('Style data:', styleData);
                    
                    // Test with map
                    await createMapWithStyle(customStyleUrl);
                } else {
                    addResult(`❌ Style access failed: ${response.status} - ${response.statusText}`, true);
                    
                    if (response.status === 401) {
                        addResult('This looks like a token permission issue. Make sure your token has the right scopes.', true);
                    } else if (response.status === 404) {
                        addResult('Style not found. Check if the style ID is correct.', true);
                    }
                }
            } catch (error) {
                addResult(`❌ Error testing style access: ${error.message}`, true);
            }
        }

        async function testWithFallback() {
            resultsDiv.innerHTML = '<p>Testing with fallback style...</p>';
            
            try {
                await createMapWithStyle('mapbox://styles/mapbox/light-v11');
                addResult('✅ Fallback style works! The issue is with your custom style.');
            } catch (error) {
                addResult(`❌ Even fallback style failed: ${error.message}`, true);
            }
        }

        async function testLayerDiscovery() {
            resultsDiv.innerHTML = '<p>Testing layer discovery...</p>';
            
            // Test your tilesets directly
            const tilesets = [
                'fieldsense.4s90abve',
                'fieldsense.4hey26iq', 
                'fieldsense.c53vz8g4',
                'fieldsense.2hebp65r'
            ];

            for (const tilesetId of tilesets) {
                try {
                    const response = await fetch(`https://api.mapbox.com/v4/${tilesetId}.json?access_token=${accessToken}`);
                    if (response.ok) {
                        const metadata = await response.json();
                        addResult(`✅ Tileset ${tilesetId} accessible - ${metadata.vector_layers?.length || 0} layers`);
                        console.log(`${tilesetId} metadata:`, metadata);
                    } else {
                        addResult(`❌ Tileset ${tilesetId} failed: ${response.status}`, true);
                    }
                } catch (error) {
                    addResult(`❌ Error with tileset ${tilesetId}: ${error.message}`, true);
                }
            }
        }

        async function createMapWithStyle(styleUrl) {
            return new Promise((resolve, reject) => {
                // Clear any existing map
                if (map) {
                    map.remove();
                }

                map = new mapboxgl.Map({
                    container: 'map',
                    style: styleUrl,
                    center: [-77.9153, 35.7218],
                    zoom: 11.5
                });

                map.on('load', () => {
                    addResult(`✅ Map loaded successfully with style: ${styleUrl}`);
                    
                    // Try to list all layers in the style
                    const layers = map.getStyle().layers;
                    addResult(`Found ${layers.length} layers in the style`);
                    
                    layers.forEach(layer => {
                        console.log(`Layer: ${layer.id}, Type: ${layer.type}, Source: ${layer.source}`);
                    });
                    
                    resolve();
                });

                map.on('error', (e) => {
                    addResult(`❌ Map error: ${e.error.message}`, true);
                    reject(e.error);
                });

                // Timeout after 10 seconds
                setTimeout(() => {
                    reject(new Error('Map load timeout'));
                }, 10000);
            });
        }

        // Auto-run basic test
        document.addEventListener('DOMContentLoaded', () => {
            addResult('Debug tool loaded. Click buttons above to test your MapBox configuration.');
        });
    </script>
</body>
</html>
